!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e=e||self).web=e.web||{},e.web.min=t())}(this,(function(){"use strict";var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};var t=function(){return(t=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function n(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){e.done?o(e.value):new n((function(t){t(e.value)})).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function r(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}var o=1;var i,s,a,c={nextValue:function(){return(o=(9301*o+49297)%233280)/233280},seed:function(e){o=e}},u="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function d(){a=!1}function p(e){if(e){if(e!==i){if(e.length!==u.length)throw new Error("Custom alphabet for shortid must be "+u.length+" unique characters. You submitted "+e.length+" characters: "+e);var t=e.split("").filter((function(e,t,n){return t!==n.lastIndexOf(e)}));if(t.length)throw new Error("Custom alphabet for shortid must be "+u.length+" unique characters. These characters were not unique: "+t.join(", "));i=e,d()}}else i!==u&&(i=u,d())}function h(){return a||(a=function(){i||p(u);for(var e,t=i.split(""),n=[],r=c.nextValue();t.length>0;)r=c.nextValue(),e=Math.floor(r*t.length),n.push(t.splice(e,1)[0]);return n.join("")}())}var l={get:function(){return i||u},characters:function(e){return p(e),i},seed:function(e){c.seed(e),s!==e&&(d(),s=e)},lookup:function(e){return h()[e]},shuffled:h},f="object"==typeof window&&(window.crypto||window.msCrypto),v=f&&f.getRandomValues?function(e){return f.getRandomValues(new Uint8Array(e))}:function(e){for(var t=[],n=0;n<e;n++)t.push(Math.floor(256*Math.random()));return t},g=function(e,t,n){for(var r=(2<<Math.log(t.length-1)/Math.LN2)-1,o=-~(1.6*r*n/t.length),i="";;)for(var s=e(o),a=o;a--;)if((i+=t[s[a]&r]||"").length===+n)return i};var m,y,b=function(e){for(var t,n=0,r="";!t;)r+=g(v,l.get(),1),t=e<Math.pow(16,n+1),n++;return r};var w=function(e){var t="",n=Math.floor(.001*(Date.now()-1567752802062));return n===y?m++:(m=0,y=n),t+=b(7),t+=b(e),m>0&&(t+=b(m)),t+=b(n)};var S=function(e){return!(!e||"string"!=typeof e||e.length<6)&&!new RegExp("[^"+l.get().replace(/[|\\{}()[\]^$+*?.-]/g,"\\$&")+"]").test(e)},x=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e){var t=0;function n(){return w(t)}e.exports=n,e.exports.generate=n,e.exports.seed=function(t){return l.seed(t),e.exports},e.exports.worker=function(n){return t=n,e.exports},e.exports.characters=function(e){return void 0!==e&&l.characters(e),l.shuffled()},e.exports.isValid=S})),_=(x.generate,x.seed,x.worker,x.characters,x.isValid,x),k=function(){function e(e,t,n,r){this.id=e,this.name=t,this.control=n,this.windows=r}return e.prototype.getURL=function(){var e;return n(this,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:return[4,this.callControl("getURL",{})];case 1:return t=n.sent(),[2,null===(e=null==t?void 0:t.returned)||void 0===e?void 0:e._value]}}))}))},e.prototype.moveResize=function(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.callControl("moveResize",e,!0)];case 1:return t.sent(),[2,this]}}))}))},e.prototype.close=function(){return n(this,void 0,void 0,(function(){var e=this;return r(this,(function(t){return[2,new Promise((function(t,n){var r=function(){i&&clearTimeout(i),o&&o()},o=e.windows.onWindowRemoved((function(n){n.id===e.id&&(t(e),r())})),i=setTimeout((function(){n("can not close window - probably not opened by your window"),r()}),1e3);e.callControl("close",{},!0).catch((function(){}))}))]}))}))},e.prototype.setTitle=function(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return"string"==typeof e&&(e={title:e}),[4,this.callControl("setTitle",e,!0)];case 1:return t.sent(),[2,this]}}))}))},e.prototype.resizeTo=function(e,t){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.callControl("moveResize",{width:e,height:t},!0)];case 1:return n.sent(),[2,this]}}))}))},e.prototype.moveTo=function(e,t){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.callControl("moveResize",{top:e,left:t},!0)];case 1:return n.sent(),[2,this]}}))}))},e.prototype.getBounds=function(){return n(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.callControl("getBounds",{})];case 1:return[2,e.sent().returned]}}))}))},e.prototype.getContext=function(){return n(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.callControl("getContext",{})];case 1:return[2,e.sent().returned]}}))}))},e.prototype.getTitle=function(){return n(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.callControl("getTitle",{})];case 1:return[2,e.sent().returned._value]}}))}))},e.prototype.onContextUpdated=function(e){throw new Error("Method not implemented.")},e.prototype.updateContext=function(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.callControl("updateContext",e,!0)];case 1:return t.sent(),[2,this]}}))}))},e.prototype.setContext=function(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.callControl("setContext",e,!0)];case 1:return t.sent(),[2,this]}}))}))},e.prototype.callControl=function(e,t,o){return void 0===o&&(o=!1),n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.control.send({command:e,domain:"windows",args:t,skipResult:o},{windowId:this.id})];case 1:return[2,n.sent()]}}))}))},e}(),I=function(){function e(){this.callbacks={}}return e.prototype.start=function(t,o){var i=this;this.interop=t,this.logger=o,this.interop.register(e.CONTROL_METHOD,(function(e){return n(i,void 0,void 0,(function(){var t,n,i;return r(this,(function(r){return t=e,o.trace("received control command "+JSON.stringify(t)),"windows"===t.domain?this.myWindow?(n=this.myWindow[t.command].call(this.myWindow,t.args),t.skipResult?[2,{}]:[2,n]):[2]:("layouts"===t.domain&&(i=this.callbacks[t.domain])&&i(t),[2])}))}))}))},e.prototype.send=function(t,n){if(!this.interop)throw new Error("Control not started");return this.logger.info("sending control command "+JSON.stringify(t)+" to "+JSON.stringify(n)+"}"),this.interop.invoke(e.CONTROL_METHOD,t,n)},e.prototype.subscribe=function(e,t){this.callbacks[e]=t},e.prototype.setLocalWindow=function(e){this.myWindow=e},e.CONTROL_METHOD="GC.Control",e}();function M(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,n={};function r(n,r){var o=n instanceof Error?n:new Error(n);if(t)t(o);else{var i='[ERROR] callback-registry: User callback for key "'+r+'" failed: '+o.stack;if(e)switch(e.errorHandling){case"log":return console.error(i);case"silent":return;case"throw":throw new Error(i)}console.error(i)}}return{add:function(e,t){var r=n[e];return r||(r=[],n[e]=r),r.push(t),function(){var r=n[e];r&&(r=r.reduce((function(e,n,r){return n===t&&e.length===r||e.push(n),e}),[]),n[e]=r)}},execute:function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];var i=n[e];if(!i||0===i.length)return[];var s=[];return i.forEach((function(n){try{var o=n.apply(void 0,t);s.push(o)}catch(t){s.push(void 0),r(t,e)}})),s},clear:function(){n={}},clearKey:function(e){n[e]&&delete n[e]}}}M.default=M;var T=M,j=function(){function e(e,t,n,r,o){this.id=e,this.name=t,this.window=n,this.control=r,this.interop=o,this.context={},this.registry=T(),r.setLocalWindow(this)}return e.prototype.getURL=function(){return n(this,void 0,void 0,(function(){return r(this,(function(e){return[2,this.window.location.href]}))}))},e.prototype.moveResize=function(e){var t=e.left,o=e.top,i=e.width,s=e.height;return n(this,void 0,void 0,(function(){return r(this,(function(e){return t=null!=t?t:window.screenLeft,o=null!=o?o:window.screenTop,i=null!=i?i:window.outerWidth,s=null!=s?s:window.outerHeight,window.moveTo(t,o),window.resizeTo(i,s),[2,this]}))}))},e.prototype.close=function(){return n(this,void 0,void 0,(function(){return r(this,(function(e){if(!this.parent)throw new Error("can not close window if it's not opened by script");try{window.close()}catch(e){console.log("what")}return[2,this]}))}))},e.prototype.setTitle=function(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){return"object"==typeof e&&null!==e&&(e=e.title),document.title=e,[2,this]}))}))},e.prototype.resizeTo=function(e,t){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.moveResize({width:e,height:t})];case 1:return n.sent(),[2,this]}}))}))},e.prototype.moveTo=function(e,t){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.moveResize({top:e,left:t})];case 1:return n.sent(),[2,this]}}))}))},e.prototype.getBounds=function(){return n(this,void 0,void 0,(function(){return r(this,(function(e){return[2,this.getBoundsSync()]}))}))},e.prototype.getContext=function(){return n(this,void 0,void 0,(function(){return r(this,(function(e){return[2,this.getContextSync()]}))}))},e.prototype.getContextSync=function(){return this.context},e.prototype.getTitle=function(){return n(this,void 0,void 0,(function(){return r(this,(function(e){return[2,this.window.document.title]}))}))},e.prototype.onContextUpdated=function(e){return this.registry.add("context-updated",e)},e.prototype.updateContext=function(e){var t=this.context;return this.context=Object.assign({},e,t),this.registry.execute("context-updated",e,t),Promise.resolve(this)},e.prototype.setContext=function(e){return n(this,void 0,void 0,(function(){var t;return r(this,(function(n){return t=this.context,this.context=Object.assign({},e),this.registry.execute("context-updated",e,t),[2,Promise.resolve(this)]}))}))},e.prototype.getBoundsSync=function(){return{left:this.window.screenLeft,top:this.window.screenTop,width:this.window.outerWidth,height:this.window.outerHeight}},e}(),C=function(t){function n(e,n,r,o,i){var s=t.call(this,n,r,o,i)||this;return s.window=e,s.id=n,s.name=r,s}return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}(n,t),n}(k),O=function(e){return'"GC.Wnd."'+e},L=function(){function e(e,t){this.interop=e,this.control=t,this.registry=T(),this.childWindows=[];var n=e.instance.windowId,r="document.title ("+_()+")";this.myWindow=new j(n,r,window,this.control,this.interop),this.trackWindowsLifetime()}return e.prototype.list=function(){var e=this,t=this.interop.methods({name:I.CONTROL_METHOD})[0];return t?(t.getServers?t.getServers():[]).reduce((function(t,n){var r=e.remoteFromServer(n);return r&&t.push(r),t}),[]):[]},e.prototype.findById=function(e){return this.list().find((function(t){return t.id===e}))},e.prototype.my=function(){return this.myWindow},e.prototype.open=function(e,t,o){var i,s,a,c,u;return n(this,void 0,void 0,(function(){var n,d,p,h,l,f,v,g,m,y,b,w,S;return r(this,(function(r){switch(r.label){case 0:return n=null!==(i=null==o?void 0:o.width)&&void 0!==i?i:400,d=null!==(s=null==o?void 0:o.height)&&void 0!==s?s:400,p=null!==(a=null==o?void 0:o.left)&&void 0!==a?a:window.screen.availWidth-window.screenLeft,h=null!==(c=null==o?void 0:o.top)&&void 0!==c?c:0,l=_(),function(e,t,n,r,o){var i,s=O(n),a={context:null!==(i=null==o?void 0:o.context)&&void 0!==i?i:{},name:r,parent:t};e.register(s,(function(){return a}))}(this.interop,this.my().id,l,e,o),(null==o?void 0:o.relativeTo)?(f=o.relativeTo,(v=this.list().find((function(e){return e.id===f})))?[4,v.getBounds()]:[3,2]):[3,2];case 1:g=r.sent(),m=null!==(u=o.relativeDirection)&&void 0!==u?u:"right",y=this.getRelativeBounds({width:n,height:d,left:p,top:h},g,m),n=y.width,d=y.height,p=y.left,h=y.top,r.label=2;case 2:if(b="width="+n+",height="+d+",left="+p+",top="+h+",scrollbars=none,location=no,status=no,menubar=no",!(w=window.open(t,l,b)))throw new Error("failed to open a window with url="+t+" and options="+b);return w.moveTo(p,h),w.resizeTo(n,d),S=new C(w,l,e,this.control,this),this.childWindows.push(S),[2,S]}}))}))},e.prototype.onWindowAdded=function(e){return this.registry.add("window-added",e)},e.prototype.onWindowRemoved=function(e){return this.registry.add("window-removed",e)},e.prototype.getChildWindows=function(){return this.childWindows=this.childWindows.filter((function(e){return!e.window.closed})),this.childWindows},e.prototype.remoteFromServer=function(e){var t;if(e.windowId)return new k(e.windowId,null!==(t=e.application)&&void 0!==t?t:"",this.control,this)},e.prototype.getRelativeBounds=function(e,t,n){switch(n){case"bottom":return{left:t.left,top:t.top+t.height+0,width:t.width,height:e.height};case"top":return{left:t.left,top:t.top-e.height-0,width:t.width,height:e.height};case"right":return{left:t.left+t.width+0,top:t.top,width:e.width,height:t.height};case"left":return{left:t.left-e.width-0,top:t.top,width:e.width,height:t.height}}throw new Error("invalid relativeDirection")},e.prototype.trackWindowsLifetime=function(){var e=this;this.interop.serverMethodAdded((function(t){var n=t.server;if(t.method.name===I.CONTROL_METHOD){var r=e.remoteFromServer(n);r&&e.registry.execute("window-added",r)}})),this.interop.serverRemoved((function(t){var n=e.remoteFromServer(t);n&&e.registry.execute("window-removed",n)}))},e}(),R=function(){function e(){}return e.prototype.getAll=function(){var e=this.getObjectFromLocalStorage();return Object.values(e)},e.prototype.get=function(e,t){return this.getObjectFromLocalStorage()[this.getKey(e,t)]},e.prototype.save=function(e){var t=this.getObjectFromLocalStorage();return t[this.getKey(e.name,e.type)]=e,this.setObjectToLocalStorage(t),Promise.resolve(e)},e.prototype.remove=function(e,t){return delete this.getObjectFromLocalStorage()[this.getKey(e,t)],Promise.resolve()},e.prototype.clear=function(){return this.setObjectToLocalStorage({}),Promise.resolve()},e.prototype.getObjectFromLocalStorage=function(){var t=window.localStorage.getItem(e.KEY);return t?JSON.parse(t):{}},e.prototype.setObjectToLocalStorage=function(t){window.localStorage.setItem(e.KEY,JSON.stringify(t))},e.prototype.getKey=function(e,t){return t+"_"+e},e.KEY="G0_layouts",e}(),P=function(){function e(e,t,n,r,o){var i,s;this.windows=e,this.interop=t,this.logger=n,this.control=r,this.storage=new R,this.registerRequestMethods(),this.control.subscribe("layouts",this.handleControlMessage.bind(this)),this.autoSaveContext=null!==(s=null===(i=null==o?void 0:o.layouts)||void 0===i?void 0:i.autoSaveWindowContext)&&void 0!==s&&s}return e.prototype.list=function(){return this.storage.getAll()},e.prototype.save=function(e){return n(this,void 0,void 0,(function(){var t,n;return r(this,(function(r){switch(r.label){case 0:return e.name?(t=this.windows.getChildWindows().map((function(e){return e.id})),[4,this.getRemoteWindowsInfo(t)]):[2,Promise.reject("missing name for layout "+JSON.stringify(e))];case 1:return(n=r.sent()).push(this.getLocalLayoutComponent(e.context,!0)),[2,this.storage.save({type:"Global",name:e.name,components:n,context:e.context||{},metadata:e.metadata||{}})]}}))}))},e.prototype.restore=function(e){return n(this,void 0,void 0,(function(){var n,o=this;return r(this,(function(r){if(!(n=this.list().find((function(t){return t.name===e.name&&"Global"===t.type}))))throw new Error("can not find layout with name "+e.name);return n.components.forEach((function(e){if("window"===e.type){var n=e.state;if(n.main)return;var r=t(t({},n.bounds),{context:n.context});o.windows.open(n.name,n.url,r)}})),[2]}))}))},e.prototype.remove=function(e,t){return this.storage.remove(t,e),Promise.resolve()},e.prototype.onSaveRequested=function(e){var t=this;return this.getLocalInfoCallback=e,function(){t.getLocalInfoCallback=void 0}},e.prototype.getLocalLayoutComponent=function(e,t){var n;void 0===t&&(t=!1);var r=this.windows.my();try{this.autoSaveContext&&(n={windowContext:r.getContextSync()}),this.getLocalInfoCallback&&(n=this.getLocalInfoCallback(e))}catch(e){this.logger.warn("onSaveRequested - error getting data from user function - "+e)}return{type:"window",componentType:"application",state:{name:r.name,context:(null==n?void 0:n.windowContext)||{},bounds:r.getBoundsSync(),url:window.document.location.href,id:r.id,parentId:r.parent,main:t}}},e.prototype.registerRequestMethods=function(){var t=this;this.interop.register(e.SaveContextMethodName,(function(e){return t.getLocalLayoutComponent(e)}))},e.prototype.handleControlMessage=function(e){return n(this,void 0,void 0,(function(){var t,n,o,i=this;return r(this,(function(r){switch(r.label){case 0:return"saveLayoutAndClose"!==(t=e).command?[3,3]:(n=t.args,[4,this.getRemoteWindowsInfo(n.childWindows)]);case 1:return(o=r.sent()).push(n.parentInfo),[4,this.storage.save({type:"Global",name:n.layoutName,components:o,context:n.context||{},metadata:n.metadata||{}})];case 2:r.sent(),n.childWindows.forEach((function(e){var t;null===(t=i.windows.findById(e))||void 0===t||t.close()})),r.label=3;case 3:return[2]}}))}))},e.prototype.getRemoteWindowsInfo=function(t){return n(this,void 0,void 0,(function(){var n,o,i,s,a,c;return r(this,(function(r){switch(r.label){case 0:for(n=[],o=function(t){var r=i.interop.servers().find((function(e){return e.windowId===t}));if(!r||!r.getMethods)return"continue";if(r.getMethods().find((function(t){return t.name===e.SaveContextMethodName})))try{n.push(i.interop.invoke(e.SaveContextMethodName,{},{windowId:t}))}catch(e){}},i=this,s=0,a=t;s<a.length;s++)c=a[s],o(c);return[4,Promise.all(n)];case 1:return[2,r.sent().map((function(e){return e.returned}))]}}))}))},e.SaveContextMethodName="T42.HC.GetSaveContext",e}(),E=function(){function e(e){this.interop=e}return e.prototype.raise=function(e){return n(this,void 0,void 0,(function(){var t,n,o=this;return r(this,(function(r){switch(r.label){case 0:if(!("Notification"in window))throw new Error("this browser does not support desktop notification");return[4,"granted"===Notification.permission?Promise.resolve("granted"):"denied"===Notification.permission?Promise.reject("no permissions from user"):Notification.requestPermission()];case 1:return r.sent(),t=this.raiseUsingWebApi(e),e.clickInterop&&(n=e.clickInterop,t.onclick=function(){var e,t;o.interop.invoke(n.method,null!==(e=null==n?void 0:n.arguments)&&void 0!==e?e:{},null!==(t=null==n?void 0:n.target)&&void 0!==t?t:"best")}),[2,t]}}))}))},e.prototype.raiseUsingWebApi=function(e){return new Notification(e.title,e)},e}(),N={worker:"/glue/worker.js",extends:"/glue/glue.config.json",layouts:{autoRestore:!1,autoSaveWindowContext:!1},logger:"error"},A=function(e){return n(void 0,void 0,void 0,(function(){var t,n,o,i,s,a;return r(this,(function(r){switch(r.label){case 0:if(!1===(t=null!==(s=null!==(i=e.extends)&&void 0!==i?i:N.extends)&&void 0!==s?s:"/glue/glue.config.json"))return[2,{}];r.label=1;case 1:return r.trys.push([1,4,,5]),[4,(c=t,void 0===u&&(u=1e3),new Promise((function(e,t){var n=!1,r=setTimeout((function(){n=!0,t(new Error("Fetch request for: "+c+" timed out at: "+u+" milliseconds"))}),u);fetch(c).then((function(t){n||(clearTimeout(r),e(t))})).catch((function(e){n||(clearTimeout(r),t(e))}))})))];case 2:return(n=r.sent()).ok?[4,n.json()]:[2,{}];case 3:return o=r.sent(),[2,null!==(a=null==o?void 0:o.glue)&&void 0!==a?a:{}];case 4:return r.sent(),[2,{}];case 5:return[2]}var c,u}))}))},D=function(e){var t="_auto_"+document.location.href,n=e.layouts.list().find((function(e){return e.name===t}));if(!n)return Promise.resolve();var r=e.windows.my();if(r.parent)return Promise.resolve();e.logger.info("restoring layout "+t);var o=n.components.find((function(e){return e.state.main}));r.setContext(null==o?void 0:o.state.context);try{return e.layouts.restore({name:t,closeRunningInstance:!1})}catch(t){return e.logger.error(t),Promise.resolve()}},q=function(e,t,o){var i=!1;window.addEventListener("beforeunload",(function(s){return n(void 0,void 0,void 0,(function(){return r(this,(function(s){return n(void 0,void 0,void 0,(function(){var n,s,a,c,u,d;return r(this,(function(r){return i||(i=!0,(null===(d=null==t?void 0:t.layouts)||void 0===d?void 0:d.autoRestore)&&(n=e.windows.getChildWindows().map((function(e){return e.id})),s=n[0],a="_auto_"+document.location.href,n.length>0?(c=e.layouts,u={domain:"layouts",command:"saveLayoutAndClose",args:{childWindows:n,closeEveryone:!0,layoutName:a,context:{},metadata:{},parentInfo:c.getLocalLayoutComponent({},!0)}},o.send(u,{windowId:s})):e.layouts.save({name:a})),e.done()),[2]}))})),[2]}))}))}))},F=function(e,t){return(F=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function W(e,t){function n(){this.constructor=e}F(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var B=function(){return(B=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function H(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){e.done?o(e.value):new n((function(t){t(e.value)})).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function U(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function K(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),o=0;for(t=0;t<n;t++)for(var i=arguments[t],s=0,a=i.length;s<a;s++,o++)r[o]=i[s];return r}var J=1,V=2,G=3,z=4;function Y(e){return e.type===G?"timestamp":e.type===V?"number":e.type===J?"string":e.type===z?"object":"unknown"}function X(e){return e.constructor===Date?"timestamp":"number"==typeof e?"number":"string"==typeof e?"string":"object"==typeof e?"object":"string"}function Q(e){var t={},n=Y(e);if("object"===n){var r=Object.keys(e.value).reduce((function(t,n){var r=X(e.value[n]);if("object"===r){var o=function e(t){return Object.keys(t).reduce((function(n,r){var o=X(t[r]);return n[r]="object"===o?{type:"object",description:"",context:{},composite:e(t[r])}:{type:o,description:"",context:{}},n}),{})}(e.value[n]);t[n]={type:"object",description:"",context:{},composite:o}}else t[n]={type:r,description:"",context:{}};return t}),{});t.composite=r}return t.name=Z(e.path.join("/")+"/"+e.name),t.type=n,t.description=e.description,t.context={},t}function Z(e){return void 0!==e&&e.length>0&&"/"!==e[0]?"/"+e:e}function $(e){return"timestamp"===Y(e)?Date.now():function e(t){if("object"!=typeof t)return t;return Object.keys(t).reduce((function(n,r){var o=t[r];return"object"==typeof o&&o.constructor!==Date?n[r]=e(o):o.constructor===Date?n[r]=new Date(o).getTime():o.constructor===Boolean?n[r]=o.toString():n[r]=o,n}),{})}(e.value)}function ee(e){var t=function e(t){return t.reduce((function(t,n){return t.concat(Array.isArray(n)?e(n):n)}),[])}(e.root.getAggregateState()),n=t.sort((function(e,t){return e.state?t.state?t.state-e.state:-1:1}))[0];return{description:function(e){var t="";return e.forEach((function(e,n,r){var o=e.path.join(".");n===r.length-1?t+=o+"."+e.name+": "+e.description:t+=o+"."+e.name+": "+e.description+","})),t.length>100?t.slice(0,100)+"...":t}(t),value:n.state}}var te=function(e,t,n){if(null===e||"object"!=typeof e)throw new Error("Missing definition");if(null===t||"object"!=typeof t)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")},ne=function(){function e(e,t,n,r,o){this.definition=e,this.system=t,this.transport=n,this.value=r,this.type=o,this.path=[],te(e,t,n),this.path=t.path.slice(0),this.path.push(t.name),this.name=e.name,this.description=e.description,n.createMetric(this)}return Object.defineProperty(e.prototype,"repo",{get:function(){var e;return null===(e=this.system)||void 0===e?void 0:e.repo},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),e.prototype.update=function(e){this.value=e,this.transport.updateMetric(this)},e}(),re=function(e){function t(t,n,r,o){return e.call(this,t,n,r,o,V)||this}return W(t,e),t.prototype.incrementBy=function(e){this.update(this.value+e)},t.prototype.increment=function(){this.incrementBy(1)},t.prototype.decrement=function(){this.incrementBy(-1)},t.prototype.decrementBy=function(e){this.incrementBy(-1*e)},t}(ne),oe=function(e){function t(t,n,r,o){return e.call(this,t,n,r,o,z)||this}return W(t,e),t.prototype.update=function(e){this.mergeValues(e),this.transport.updateMetric(this)},t.prototype.mergeValues=function(e){var t=this;return Object.keys(this.value).forEach((function(n){void 0!==e[n]&&(t.value[n]=e[n])}))},t}(ne),ie=function(e){function t(t,n,r,o){return e.call(this,t,n,r,o,J)||this}return W(t,e),t}(ne),se=function(e){function t(t,n,r,o){return e.call(this,t,n,r,o,G)||this}return W(t,e),t.prototype.now=function(){this.update(new Date)},t}(ne);var ae=function(){function e(e,t){t.init(this),this.root=function e(t,n,r,o,i){if(!n)throw new Error("Repository is required");if(!r)throw new Error("Transport is required");var s,a,c=r,u=t,d=i||"",p=n,h=o,l=function e(t){if(!t||!t.parent)return[];var n=e(t.parent);return n.push(t.name),n}(o),f={},v=(a="/",((s=l)&&s.length>0?s.join(a):"")+t),g=n.root,m=[],y=[];function b(e,t,n,r){var o={name:""};o="string"==typeof e?{name:e}:e;var i=y.filter((function(e){return e.name===o.name}));if(i.length>0){var s=i[0];if(s.type!==t)throw new Error("A metric named "+o.name+" is already defined with different type.");return void 0!==n&&s.update(n),s}var a=r(o);return y.push(a),a}var w={get name(){return u},get description(){return d},get repo(){return p},get parent(){return h},path:l,id:v,root:g,get subSystems(){return m},get metrics(){return y},subSystem:function(t,n){if(!t||0===t.length)throw new Error("name is required");var r=m.filter((function(e){return e.name===t}));if(r.length>0)return r[0];var o=e(t,p,c,w,n);return m.push(o),o},getState:function(){return f},setState:function(e,t){f={state:e,description:t},c.updateSystem(w,f)},stringMetric:function(e,t){return b(e,J,t,(function(e){return new ie(e,w,c,t)}))},timestampMetric:function(e,t){return b(e,G,t,(function(e){return new se(e,w,c,t)}))},objectMetric:function(e,t){return b(e,z,t,(function(e){return new oe(e,w,c,t)}))},numberMetric:function(e,t){return b(e,V,t,(function(e){return new re(e,w,c,t)}))},getAggregateState:function(){var e=[];return Object.keys(f).length>0&&e.push({name:u,path:l,state:f.state,description:f.description}),m.forEach((function(t){var n=t.getAggregateState();n.length>0&&e.push.apply(e,n)})),e}};return c.createSystem(w),w}("",this,t),this.addSystemMetrics(this.root,e.clickStream||void 0===e.clickStream)}return e.prototype.addSystemMetrics=function(e,t){if("undefined"!=typeof navigator&&e.stringMetric("UserAgent",navigator.userAgent),t&&"undefined"!=typeof document){var n=e.subSystem("ClickStream"),r=function(e){if(e.target){var t=e.target;n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:e.target?t.className:"",id:t.id,type:"<"+t.tagName.toLowerCase()+">",href:t.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",r):document.attachEvent("onclick",r)}e.stringMetric("StartTime",(new Date).toString());var o=e.stringMetric("StartURL",""),i=e.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;o.update(s)}void 0!==window.glue42gd&&i.update(window.glue42gd.appName)}},e}(),ce=function(){function e(){}return e.prototype.init=function(e){},e.prototype.createSystem=function(e){},e.prototype.updateSystem=function(e,t){},e.prototype.createMetric=function(e){},e.prototype.updateMetric=function(e){},e}(),ue=function(e){var t;return t=e.connection&&"object"==typeof e.connection?function(e,t){if(!e||"object"!=typeof e)throw new Error("Connection is required parameter");var n,r,o=function(e){i(e.root)},i=function(e){s(e),e.metrics.forEach((function(e){a(e)})),e.subSystems.forEach((function(e){i(e)}))},s=function(e){void 0!==e.parent&&n.then((function(){var t={type:"define",metrics:[{name:Z(e.path.join("/")+"/"+e.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};r.send(t)}))},a=function(e){var t=u(e);n.then((function(){var e={type:"define",metrics:[Q(t)]};r.send(e),void 0!==t.value&&c(t)}))},c=function(e){var t=$(e),n={type:"publish",values:[{name:Z(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};r.send(n)},u=function(e){var t=B({},e);return"object"==typeof e.value&&null!==e.value&&(t.value=B({},e.value)),t};return{init:function(t){var i;n=new Promise((function(e){i=e})),(r=e.domain("metrics")).onJoined((function(e){!e&&i&&(i(),i=void 0);var n={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};r.send(n),e&&o(t)})),r.join()},createSystem:s,updateSystem:function(t,o){n.then((function(){var n={type:"publish",values:[{name:Z(t.path.join("/")+"/"+t.name+"/State"),value:{Description:o.description,Value:o.state},timestamp:Date.now()}]};r.send(n);var i=ee(t),s={type:"publish",peer_id:e.peerId,values:[{name:"/State",value:{Description:i.description,Value:i.value},timestamp:Date.now()}]};r.send(s)}))},createMetric:a,updateMetric:function(e){var t=u(e);n.then((function(){return c(t)}))}}}(e.connection):new ce,new ae(e,t).root};function de(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,n={};function r(n,r){var o=n instanceof Error?n:new Error(n);if(t)t(o);else{var i='[ERROR] callback-registry: User callback for key "'+r+'" failed: '+o.stack;if(e)switch(e.errorHandling){case"log":return console.error(i);case"silent":return;case"throw":throw new Error(i)}console.error(i)}}return{add:function(e,t){var r=n[e];return r||(r=[],n[e]=r),r.push(t),function(){var r=n[e];r&&(r=r.reduce((function(e,n,r){return n===t&&e.length===r||e.push(n),e}),[]),n[e]=r)}},execute:function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];var i=n[e];if(!i||0===i.length)return[];var s=[];return i.forEach((function(n){try{var o=n.apply(void 0,t);s.push(o)}catch(t){s.push(void 0),r(t,e)}})),s},clear:function(){n={}},clearKey:function(e){n[e]&&delete n[e]}}}de.default=de;var pe=de,he=function(){function e(e,t){var n=this;this.registry=pe(),this.gw=e.facade,this.gw.connect((function(e,t){n.messageHandler(t)})).then((function(e){n.client=e}))}return Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return this.client?(this.client.send(e),Promise.resolve(void 0)):Promise.reject("not connected")},e.prototype.send=function(e){return Promise.reject("not supported")},e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.onConnectedChanged=function(e){e(!0)},e.prototype.close=function(){return Promise.resolve()},e.prototype.open=function(){return Promise.resolve()},e.prototype.name=function(){return"in-memory"},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.messageHandler=function(e){this.registry.execute("onMessage",e)},e}(),le=function(){function e(e,t){var n=this;this.logger=t,this.registry=pe(),this.worker=new SharedWorker(e),this.worker.port.onmessage=function(e){n.messageHandler(e.data)}}return Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return this.worker.port.postMessage(e),Promise.resolve()},e.prototype.send=function(e){return Promise.reject("not supported")},e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.onConnectedChanged=function(e){e(!0)},e.prototype.close=function(){return Promise.resolve()},e.prototype.open=function(){return Promise.resolve()},e.prototype.name=function(){return"shared-worker"},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.messageHandler=function(e){this.registry.execute("onMessage",e)},e}(),fe=function(){function e(){}return e.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var e=Number(window.glueDesktop.version.substr(0,1));return isNaN(e)?void 0:e}},e.isNode=function(){if(void 0!==e._isNode)return e._isNode;try{e._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(t){e._isNode=!1}return e._isNode},e}(),ve=function(){function e(){var e=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(t,n){e.resolve=function(n){e.resolved=!0,t(n)},e.reject=function(t){e.rejected=!0,n(t)}}))}return e.delay=function(e){return new Promise((function(t){return setTimeout(t,e)}))},Object.defineProperty(e.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),e}(),ge=fe.isNode()?require("ws"):window.WebSocket,me=function(){function e(e,t){if(this._running=!0,this._registry=pe(),this.wsRequests=[],this.settings=e,this.logger=t,!this.settings.ws)throw new Error("ws is missing")}return e.prototype.onMessage=function(e){return this._registry.add("onMessage",e)},e.prototype.send=function(e,t){var n=this;return new Promise((function(t,r){n.waitForSocketConnection((function(){var o;try{null===(o=n.ws)||void 0===o||o.send(e),t()}catch(e){r(e)}}),r)}))},e.prototype.open=function(){var e=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(t,n){e.waitForSocketConnection(t,n)}))},e.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},e.prototype.onConnectedChanged=function(e){return this._registry.add("onConnectedChanged",e)},e.prototype.name=function(){return"ws "+this.settings.ws},e.prototype.reconnect=function(){var e;null===(e=this.ws)||void 0===e||e.close();var t=new ve;return this.waitForSocketConnection((function(){t.resolve()})),t.promise},e.prototype.waitForSocketConnection=function(e,t){var n;t=null!=t?t:function(){},this._running?1!==(null===(n=this.ws)||void 0===n?void 0:n.readyState)?(this.wsRequests.push({callback:e,failed:t}),this.wsRequests.length>1||this.openSocket()):e():t("wait for socket on "+this.settings.ws+" failed - socket closed by user")},e.prototype.openSocket=function(e,t){return H(this,void 0,void 0,(function(){var n=this;return U(this,(function(r){switch(r.label){case 0:if(void 0===e&&(e=this.settings.reconnectInterval),void 0!==t){if(0===t)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+t+" more times (every "+e+" ms)")}r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return r.sent(),this.notifyForSocketState(),[3,4];case 3:return r.sent(),setTimeout((function(){var r=void 0===t?void 0:t-1;n.openSocket(e,r)}),e),[3,4];case 4:return[2]}}))}))},e.prototype.initiateSocket=function(){var e=this,t=new ve;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new ge(this.settings.ws||""),this.ws.onerror=function(n){var r="";try{r=JSON.stringify(n)}catch(e){var o=new WeakSet;r=JSON.stringify(n,(function(e,t){if("object"==typeof t&&null!==t){if(o.has(t))return;o.add(t)}return t}))}t.reject("error"),e.notifyStatusChanged(!1,r)},this.ws.onclose=function(n){e.logger.info("ws closed "+n),t.reject("closed"),e.notifyStatusChanged(!1)},this.ws.onopen=function(){var n;e.logger.info("ws opened "+(null===(n=e.settings.identity)||void 0===n?void 0:n.application)),t.resolve(),e.notifyStatusChanged(!0)},this.ws.onmessage=function(t){e._registry.execute("onMessage",t.data)},t.promise},e.prototype.notifyForSocketState=function(e){this.wsRequests.forEach((function(t){e?t.failed&&t.failed(e):t.callback()})),this.wsRequests=[]},e.prototype.notifyStatusChanged=function(e,t){this._registry.execute("onConnectedChanged",e,t)},e}();var ye=1;var be,we,Se,xe={nextValue:function(){return(ye=(9301*ye+49297)%233280)/233280},seed:function(e){ye=e}},_e="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function ke(){Se=!1}function Ie(e){if(e){if(e!==be){if(e.length!==_e.length)throw new Error("Custom alphabet for shortid must be "+_e.length+" unique characters. You submitted "+e.length+" characters: "+e);var t=e.split("").filter((function(e,t,n){return t!==n.lastIndexOf(e)}));if(t.length)throw new Error("Custom alphabet for shortid must be "+_e.length+" unique characters. These characters were not unique: "+t.join(", "));be=e,ke()}}else be!==_e&&(be=_e,ke())}function Me(){return Se||(Se=function(){be||Ie(_e);for(var e,t=be.split(""),n=[],r=xe.nextValue();t.length>0;)r=xe.nextValue(),e=Math.floor(r*t.length),n.push(t.splice(e,1)[0]);return n.join("")}())}var Te={characters:function(e){return Ie(e),be},seed:function(e){xe.seed(e),we!==e&&(ke(),we=e)},lookup:function(e){return Me()[e]},shuffled:Me},je="object"==typeof window&&(window.crypto||window.msCrypto);var Ce=function(){if(!je||!je.getRandomValues)return 48&Math.floor(256*Math.random());var e=new Uint8Array(1);return je.getRandomValues(e),48&e[0]};var Oe=function(e,t){for(var n,r=0,o="";!n;)o+=e(t>>4*r&15|Ce()),n=t<Math.pow(16,r+1),r++;return o};var Le=function(e){var t=Te.shuffled();return{version:15&t.indexOf(e.substr(0,1)),worker:15&t.indexOf(e.substr(1,1))}};var Re=function(e){if(!e||"string"!=typeof e||e.length<6)return!1;for(var t=Te.characters(),n=e.length,r=0;r<n;r++)if(-1===t.indexOf(e[r]))return!1;return!0},Pe=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e){var t,n,r=0;function o(){var e="",o=Math.floor(.001*(Date.now()-1459707606518));return o===n?t++:(t=0,n=o),e+=Oe(Te.lookup,6),e+=Oe(Te.lookup,r),t>0&&(e+=Oe(Te.lookup,t)),e+=Oe(Te.lookup,o)}e.exports=o,e.exports.generate=o,e.exports.seed=function(t){return Te.seed(t),e.exports},e.exports.worker=function(t){return r=t,e.exports},e.exports.characters=function(e){return void 0!==e&&Te.characters(e),Te.shuffled()},e.exports.decode=Le,e.exports.isValid=Re})),Ee=(Pe.generate,Pe.seed,Pe.worker,Pe.characters,Pe.decode,Pe.isValid,Pe);function Ne(e,t,n,r,o){null==e&&(e="global"),r=r||["success"],o=o||["error"];var i,s=!1,a=!1,c=!1,u=pe();t.disconnected((function(){c=!1,n.debug("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),t.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),p(i))})),t.on("success",(function(e){return l(e)})),t.on("error",(function(e){return h(e)})),t.on("result",(function(e){return l(e)})),r&&r.forEach((function(e){t.on(e,(function(e){return l(e)}))})),o&&o.forEach((function(e){t.on(e,(function(e){return h(e)}))}));var d={};function p(t){return i=t,new Promise((function(r,o){if(s)r();else{var i;if("global"===e)i=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining domain "+e),i=v({type:"join",destination:e,domain:"global",options:t});i.then((function(){!function(){n.debug("did join "+e),s=!0;var t=a;a=!1,u.execute("onJoined",t)}(),r()})).catch((function(t){n.debug("error joining "+e+" domain: "+JSON.stringify(t)),o(t)}))}}))}function h(t){if(e===t.domain){var n=t.request_id;if(n){var r=d[n];r&&r.error(t)}}}function l(t){if(t.domain===e){var n=t.request_id;if(n){var r=d[n];r&&r.success(t)}}}function f(){return Ee()}function v(r,o,i){i=i||{},r.request_id=r.request_id||f(),r.domain=r.domain||e,i.skipPeerId||(r.peer_id=t.peerId);var s=r.request_id;return new Promise((function(e,a){d[s]={success:function(t){delete d[s],t._tag=o,e(t)},error:function(e){n.warn("GW error - "+JSON.stringify(e)+" for request "+JSON.stringify(r)),delete d[s],e._tag=o,a(e)}},t.send(r,i).catch((function(e){d[s].error({err:e})}))}))}return{join:p,leave:function(){return"global"===e?Promise.resolve():(n.debug("stopping session "+e+"..."),a=!1,v({type:"leave",destination:e,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})))},onJoined:function(e){return s&&e(!1),u.add("onJoined",e)},onLeft:function(e){return s||e(),u.add("onLeft",e)},send:v,sendFireAndForget:function(n){n.request_id=n.request_id?n.request_id:f(),n.domain=n.domain||e,n.peer_id=t.peerId,t.send(n)},on:function(r,o){t.on(r,(function(t){if(t.domain===e)try{o(t)}catch(e){n.error("Callback  failed: "+e+" \n "+e.stack+" \n msg was: "+JSON.stringify(t),e)}}))},loggedIn:function(e){return t.loggedIn(e)},connected:function(e){return t.connected(e)},disconnected:function(e){return t.disconnected(e)},get peerId(){return t.peerId},get domain(){return e}}}var Ae=function(){function e(e,t,n){var r=this;this.connection=e,this.settings=t,this.logger=n,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=pe(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],e.disconnected((function(){r.handleDisconnected()})),this.ping()}return Object.defineProperty(e.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),e.prototype.processStringMessage=function(e){var t=this,n=JSON.parse(e,(function(e,n){if("string"!=typeof n)return n;if(n.length<t.dateMinLen)return n;if(n[0]!==t.datePrefixFirstChar)return n;if(n.substring(0,t.datePrefixLen)!==t.datePrefix)return n;try{var r=parseInt(n.substring(t.datePrefixLen,n.length),10);return isNaN(r)?n:new Date(r)}catch(e){return n}}));return{msg:n,msgType:n.type}},e.prototype.createStringMessage=function(e){var t=Date.prototype.toJSON;try{var n=this.datePrefix;return Date.prototype.toJSON=function(){return n+this.getTime()},JSON.stringify(e)}finally{Date.prototype.toJSON=t}},e.prototype.processObjectMessage=function(e){if(!e.type)throw new Error("Object should have type property");return{msg:e,msgType:e.type}},e.prototype.createObjectMessage=function(e){return e},e.prototype.login=function(e,t){return H(this,void 0,void 0,(function(){var n,r,o,i,s,a,c,u,d,p;return U(this,(function(h){switch(h.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=e,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,n={},this.connection.gatewayToken=e.gatewayToken,!e.gatewayToken)return[3,5];if(!t)return[3,4];h.label=1;case 1:return h.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return u=h.sent(),e.gatewayToken=u,[3,4];case 3:return r=h.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==r?void 0:r.message)||r)),[3,4];case 4:return n.method="gateway-token",n.token=e.gatewayToken,this.connection.gatewayToken=e.gatewayToken,[3,10];case 5:return"sspi"!==e.flowName?[3,9]:(n.provider="win",n.method="access-token",e.flowCallback&&e.sessionId?(o=n,[4,e.flowCallback(e.sessionId,null)]):[3,7]);case 6:return o.token=h.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(e.token)n.method="access-token",n.token=e.token;else{if(!e.username)throw new Error("invalid auth message"+JSON.stringify(e));n.method="secret",n.login=e.username,n.secret=e.password}h.label=10;case 10:i={type:"hello",identity:this.settings.identity,authentication:n},e.sessionId&&(i.request_id=e.sessionId),this.globalDomain=Ne("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),s={skipPeerId:!0},this.initialLogin&&(s.retryInterval=this.settings.reconnectInterval,s.maxRetries=this.settings.reconnectAttempts),h.label=11;case 11:h.trys.push([11,19,20,21]),a=void 0,h.label=12;case 12:return[4,this.globalDomain.send(i,void 0,s)];case 13:return"authentication-request"!==(c=h.sent()).type?[3,16]:(u=Buffer.from(c.authentication.token,"base64"),e.flowCallback&&e.sessionId?(d=i.authentication,[4,e.flowCallback(e.sessionId,u)]):[3,15]);case 14:d.token=h.sent().data.toString("base64"),h.label=15;case 15:return i.request_id=e.sessionId,[3,12];case 16:if("welcome"===c.type)return a=c,[3,18];throw"error"===c.type?new Error("Authentication failed: "+c.reason):new Error("Unexpected message type during authentication: "+c.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.info("login successful with peerId "+a.peer_id),this.connection.peerId=a.peer_id,this.connection.resolvedIdentity=a.resolved_identity,this.connection.availableDomains=a.available_domains,a.options&&(this.connection.token=a.options.access_token,this.connection.info=a.options.info),this.setLoggedIn(!0),[2,a.resolved_identity];case 19:throw p=h.sent(),this.logger.error("error sending hello message - "+(p.message||p.msg||p.reason||p),p),p;case 20:return e&&e.flowCallback&&e.sessionId&&e.flowCallback(e.sessionId,null),[7];case 21:return[2]}}))}))},e.prototype.logout=function(){return H(this,void 0,void 0,(function(){var e;return U(this,(function(t){switch(t.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),e=this.sessions.map((function(e){e.leave()})),[4,Promise.all(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.loggedIn=function(e){return this._isLoggedIn&&e(),this.registry.add("onLoggedIn",e)},e.prototype.domain=function(e,t,n,r){var o=this.sessions.filter((function(t){return t.domain===e}))[0];return o||(o=Ne(e,this.connection,t,n,r),this.sessions.push(o)),o},e.prototype.handleDisconnected=function(){var e=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(e.handleDisconnected,1e3)}))}},e.prototype.setLoggedIn=function(e){this._isLoggedIn=e,this._isLoggedIn&&this.registry.execute("onLoggedIn")},e.prototype.ping=function(){var e=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){e.ping()}),3e4))},e.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(e){return e.token})):Promise.reject(new Error("no global domain session"))},e.prototype.getNewGWToken=function(){if(void 0!==typeof window){var e=window.glue42gd;if(e)return e.getGWToken()}return Promise.reject(new Error("not running in GD"))},e}(),De=function(){function e(e){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var t=0,n=e;t<n.length;t++){var r=n[t];this.specs[r.name]=r,this.specsNames.push(r.name)}}return e.prototype.init=function(e){var t=this;this.connection=e;for(var n=0,r=this.specsNames;n<r.length;n++)for(var o=r[n],i=function(n){var r=s.subsRefCount[n];if(r||(r=0),r+=1,s.subsRefCount[n]=r,r>1)return"continue";var o=e.on(n,(function(e){return t.processMessage(n,e)}));s.subs[n]=o},s=this,a=0,c=this.specs[o].types;a<c.length;a++){i(c[a])}},e.prototype.processMessage=function(e,t){if(!this.isDone&&t)for(var n=0,r=this.specsNames;n<r.length;n++){var o=r[n];if(-1!==this.specs[o].types.indexOf(e)){var i=this.messages[o]||[];this.messages[o]=i,i.push(t)}}},e.prototype.drain=function(e,t){var n;t&&(this.messages[e]||[]).forEach(t),delete this.messages[e];for(var r=0,o=this.specs[e].types;r<o.length;r++){var i=o[r];this.subsRefCount[i]-=1,this.subsRefCount[i]<=0&&(null===(n=this.connection)||void 0===n||n.off(this.subs[i]),delete this.subs[i],delete this.subsRefCount[i])}delete this.specs[e],this.specs.length||(this.isDone=!0)},e}(),qe=function(){function e(e,t){if(this.settings=e,this.logger=t,this.messageHandlers={},this.ids=1,this.registry=pe(),this._connected=!1,this.isTrace=!1,(e=e||{}).reconnectAttempts=e.reconnectAttempts||10,e.reconnectInterval=e.reconnectInterval||1e3,e.inproc)this.transport=new he(e.inproc,t.subLogger("inMemory"));else if(e.sharedWorker)this.transport=new le(e.sharedWorker,t.subLogger("shared-worker"));else{if(void 0===e.ws)throw new Error("No connection information specified");this.transport=new me(e,t.subLogger("ws"))}this.isTrace=t.canPublish("trace"),t.info("starting with "+this.transport.name()+" transport"),this.protocol=new Ae(this,e,t.subLogger("protocol")),this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this.transport.onMessage(this.handleTransportMessage.bind(this)),e.replaySpecs&&e.replaySpecs.length&&(this.replayer=new De(e.replaySpecs),this.replayer.init(this))}return Object.defineProperty(e.prototype,"protocolVersion",{get:function(){var e;return null===(e=this.protocol)||void 0===e?void 0:e.protocolVersion},enumerable:!0,configurable:!0}),e.prototype.send=function(e,t){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var n=this.protocol.createObjectMessage(e);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(n)),this.transport.sendObject(n,t)}var r=this.protocol.createStringMessage(e);return this.isTrace&&this.logger.trace(">> "+r),this.transport.send(r,t)},e.prototype.on=function(e,t){e=e.toLowerCase(),void 0===this.messageHandlers[e]&&(this.messageHandlers[e]={});var n=this.ids++;return this.messageHandlers[e][n]=t,{type:e,id:n}},e.prototype.off=function(e){delete this.messageHandlers[e.type.toLowerCase()][e.id]},Object.defineProperty(e.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),e.prototype.connected=function(e){var t=this;return this.protocol.loggedIn((function(){e(t.settings.ws||t.settings.sharedWorker||"")}))},e.prototype.disconnected=function(e){return this.registry.add("disconnected",e)},e.prototype.login=function(e,t){return H(this,void 0,void 0,(function(){return U(this,(function(n){switch(n.label){case 0:return[4,this.transport.open()];case 1:return n.sent(),[2,this.protocol.login(e,t)]}}))}))},e.prototype.logout=function(){return H(this,void 0,void 0,(function(){return U(this,(function(e){switch(e.label){case 0:return[4,this.protocol.logout()];case 1:return e.sent(),[4,this.transport.close()];case 2:return e.sent(),[2]}}))}))},e.prototype.loggedIn=function(e){return this.protocol.loggedIn(e)},e.prototype.domain=function(e,t,n){return this.protocol.domain(e,this.logger.subLogger("domain="+e),t,n)},e.prototype.authToken=function(){return this.protocol.authToken()},e.prototype.reconnect=function(){return this.transport.reconnect()},e.prototype.distributeMessage=function(e,t){var n=this,r=this.messageHandlers[t.toLowerCase()];void 0!==r&&Object.keys(r).forEach((function(t){var o=r[t];if(void 0!==o)try{o(e)}catch(e){n.logger.error("Message handler failed with "+e.stack,e)}}))},e.prototype.handleConnectionChanged=function(e){this._connected!==e&&(this._connected=e,e?this.registry.execute("connected"):this.registry.execute("disconnected"))},e.prototype.handleTransportMessage=function(e){var t;t="string"==typeof e?this.protocol.processStringMessage(e):this.protocol.processObjectMessage(e),this.isTrace&&this.logger.trace("<< "+JSON.stringify(t)),this.distributeMessage(t.msg,t.msgType)},e}(),Fe=["trace","debug","info","warn","error","off"],We=function(){function e(e,t,n){this.name=e,this.parent=t,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=e,this.path=t?t.path+"."+e:e,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}return e.prototype.subLogger=function(t){var n=this.subLoggers.filter((function(e){return e.name===t}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(e){if(e===t)throw new Error("This sub logger name is not allowed.")}));var r=new e(t,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(r),r},e.prototype.publishLevel=function(e){var t;return e&&(this._publishLevel=e),this._publishLevel||(null===(t=this.parent)||void 0===t?void 0:t.publishLevel())},e.prototype.consoleLevel=function(e){var t;return e&&(this._consoleLevel=e),this._consoleLevel||(null===(t=this.parent)||void 0===t?void 0:t.consoleLevel())},e.prototype.log=function(e,t,n){this.publishMessage(t||"info",e,n)},e.prototype.trace=function(e){this.log(e,"trace")},e.prototype.debug=function(e){this.log(e,"debug")},e.prototype.info=function(e){this.log(e,"info")},e.prototype.warn=function(e){this.log(e,"warn")},e.prototype.error=function(e,t){this.log(e,"error")},e.prototype.canPublish=function(e,t){return Fe.indexOf(e)>=Fe.indexOf(t||this.consoleLevel()||"trace")},e.prototype.publishMessage=function(t,n,r){var o,i,s=this.loggerFullName;if("error"===t&&!r){var a=new Error;a.stack&&(n=n+"\n"+a.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(t,this.publishLevel())&&(null===(o=e.Interop)||void 0===o?void 0:o.methods({name:e.InteropMethodName}).length)>0&&(null===(i=e.Interop)||void 0===i||i.invoke(e.InteropMethodName,{msg:""+n,logger:s,level:t})),this.canPublish(t)){var c="";if(this.includeTimeAndLevel){var u=new Date;c="["+(u.getHours()+":"+u.getMinutes()+":"+u.getSeconds()+":"+u.getMilliseconds())+"] ["+t+"] "}var d=""+c+s+": "+n;switch(t){case"trace":this.logFn.debug(d);break;case"debug":this.logFn.debug?this.logFn.debug(d):this.logFn.log(d);break;case"info":this.logFn.info(d);break;case"warn":this.logFn.warn(d);break;case"error":this.logFn.error(d,r)}}},e.InteropMethodName="T42.AppLogger.Log",e}(),Be={get name(){return"context"},get types(){return["create-context","created","destroyed","context-created","context-added","subscribe-context","subscribed-context","unsubscribe-context","destroy-context","context-destroyed","update-context","context-updated","joined"]}};function He(e,t,n){var r,o,i,s,a;if(fe.isNode()){var c=process.env._GD_STARTING_CONTEXT_;if(c)try{a=JSON.parse(c)}catch(e){}}var u=function(){var r,o,i,s,c,u,d,p,h,l=e.gateway,f=null!==(r=null==l?void 0:l.protocolVersion)&&void 0!==r?r:3,v=null==l?void 0:l.reconnectInterval,g=null==l?void 0:l.reconnectAttempts,m=null==l?void 0:l.ws,y=null==l?void 0:l.sharedWorker,b=null==l?void 0:l.inproc;n&&(m=n.gwURL),fe.isNode()&&a&&a.gwURL&&(m=a.gwURL),m||y||b||(m="ws://localhost:8385");var w=function(){if(e.application)return e.application;if(n)return n.applicationName;var t=Ee();if(fe.isNode())return a?a.applicationConfig.name:"NodeJS"+t;if("undefined"!=typeof window&&"undefined"!=typeof document)return document.title+" ("+t+")";return t}(),S=w;void 0!==n?(u=n.windowId,d=n.pid,n.env&&(p=n.env.env,h=n.env.region),S=null!==(o=n.application)&&void 0!==o?o:"glue-app",c=n.appInstanceId):fe.isNode()?(d=process.pid,a&&(p=a.env,h=a.region,c=a.instanceId)):u=window.name||Ee();var x=null!==(s=null===(i=e.gateway)||void 0===i?void 0:i.replaySpecs)&&void 0!==s?s:[];return x.push(Be),{identity:{application:S,applicationName:w,windowId:u,instance:c,process:d,region:h,environment:p,api:t.version||"5.0.1"},reconnectInterval:v,ws:m,sharedWorker:y,inproc:b,protocolVersion:f,reconnectAttempts:g,replaySpecs:x}}();return{bus:null!==(r=e.bus)&&void 0!==r&&r,auth:function(){var t,n;return"string"==typeof e.auth?{token:e.auth}:e.auth?e.auth:fe.isNode()&&a&&a.gwToken?{gatewayToken:a.gwToken}:(null===(t=e.gateway)||void 0===t?void 0:t.inproc)||(null===(n=e.gateway)||void 0===n?void 0:n.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var t,n,r=e.logger;return r||(r="error"),"string"==typeof r?{console:r,publish:"error"}:{console:null!==(t=r.console)&&void 0!==t?t:"error",publish:null!==(n=r.publish)&&void 0!==n?n:"error"}}(),connection:u,metrics:null===(o=e.metrics)||void 0===o||o,contexts:null===(i=e.contexts)||void 0===i||i,version:t.version||"5.0.1",libs:null!==(s=t.libs)&&void 0!==s?s:[],customLogger:e.customLogger}}function Ue(){function e(){return(new Date).getTime()}var t,n,r=e();return{get startTime(){return r},get endTime(){return t},get period(){return n},stop:function(){return t=e(),n=e()-r}}}var Ke=function(){function e(e,t,n,r){this.updateCallbacks={},this.contextId=e,this.name=t,this.isAnnounced=n,this.activityId=r,this.context={}}return e.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},e.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},e}();function Je(e,t){if(t){if(t.reset)return e=B({},t.reset);e=Ve(e,void 0);var n=t.added,r=t.updated,o=t.removed;n&&Object.keys(n).forEach((function(t){e[t]=n[t]})),r&&Object.keys(r).forEach((function(t){Ge(t,e,r)})),o&&o.forEach((function(t){delete e[t]}))}return e}function Ve(e,t){if(t=t||new WeakMap,Object(e)!==e)return e;if(e instanceof Set)return new Set(e);if(t.has(e))return t.get(e);var n=e instanceof Date?new Date(e):e instanceof RegExp?new RegExp(e.source,e.flags):e.constructor?new e.constructor:Object.create(null);return t.set(e,n),Object.assign.apply(Object,K([n],Object.keys(e).map((function(n){var r;return(r={})[n]=Ve(e[n],t),r}))))}var Ge=function(e,t,n){var r=n[e];if(void 0===r)return t;var o=t[e];return o&&r?"string"==typeof o||"number"==typeof o||"boolean"==typeof o||"string"==typeof r||"number"==typeof r||"boolean"==typeof r||Array.isArray(o)||Array.isArray(r)?(t[e]=r,t):(t[e]=Object.assign({},o,r),t):(t[e]=r,t)};function ze(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(var n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(e[n]!==t[n]){if("object"!=typeof e[n])return!1;if(!ze(e[n],t[n]))return!1}}for(var n in t)if(t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}var Ye,Xe=function(){function e(e){var t,n=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._connection=e.connection,this._logger=e.logger,this._gw3Session=this._connection.domain("global",["context-created","subscribed-context","context-destroyed","context-updated"]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(t=this._connection.replayer)||void 0===t||t.drain(Be.name,(function(e){var t=e.type;t&&("context-created"===t||"context-added"===t||"created"===t?n.handleContextCreatedMessage(e):"subscribed-context"===t||"context-updated"===t||"joined"===t?n.handleContextUpdatedMessage(e):"context-destroyed"!==t&&"destroyed"!==t||n.handleContextDestroyedMessage(e))}))}return e.prototype.dispose=function(){for(var e=0,t=this._gw3Subscriptions;e<t.length;e++){var n=t[e];this._connection.off(n)}for(var r in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(r)&&delete this._contextNameToData[r]},e.prototype.createContext=function(e,t){var n=this;return this._gw3Session.send({type:"create-context",domain:"global",name:e,data:t,lifetime:"retained"}).then((function(r){if(n._contextNameToId[e]=r.context_id,!n._contextIdToName[r.context_id]){n._contextIdToName[r.context_id]=e;var o=n._contextNameToData[e]||new Ke(r.context_id,e,!0,void 0);return o.isAnnounced=!0,o.name=e,o.contextId=r.context_id,n._contextNameToData[e]=o,o.context=r.data,o.sentExplicitSubscription=!0,o.context&&n.invokeUpdateCallbacks(o,o.context,void 0),n.update(e,t).then((function(){return r.context_id}))}return r.context_id}))},e.prototype.all=function(){var e=this;return Object.keys(this._contextNameToData).filter((function(t){return e._contextNameToData[t].isAnnounced}))},e.prototype.update=function(e,t){return H(this,void 0,void 0,(function(){var n,r,o,i=this;return U(this,(function(s){switch(s.label){case 0:return(n=this._contextNameToData[e])&&n.isAnnounced?(r=n.context,n.hasCallbacks()?[3,2]:[4,this.get(n.name,!1)]):[2,this.createContext(e,t)];case 1:r=s.sent(),s.label=2;case 2:return o=this.calculateContextDelta(r,t),Object.keys(o.added).length||Object.keys(o.updated).length||o.removed.length?[2,this._gw3Session.send({type:"update-context",domain:"global",context_id:n.contextId,delta:o},{},{skipPeerId:!1}).then((function(e){i.handleUpdated(n,o,{updaterId:e.peer_id})}))]:[2,Promise.resolve()]}}))}))},e.prototype.set=function(e,t){var n=this,r=this._contextNameToData[e];return r&&r.isAnnounced?this._gw3Session.send({type:"update-context",domain:"global",context_id:r.contextId,delta:{reset:t}},{},{skipPeerId:!1}).then((function(e){n.handleUpdated(r,{reset:t,added:{},removed:[],updated:{}},{updaterId:e.peer_id})})):this.createContext(e,t)},e.prototype.get=function(e,t){var n=this;void 0===t&&(t=!0);var r=this._contextNameToData[e];return r&&r.isAnnounced&&r.hasCallbacks()||t?Promise.resolve(r&&r.context):new Promise((function(t,r){return H(n,void 0,void 0,(function(){var n=this;return U(this,(function(r){return this.subscribe(e,(function(e,r,o,i){n.unsubscribe(i),t(e)})),[2]}))}))}))},e.prototype.subscribe=function(e,t){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var r=this._contextNameToData[e];if(!r||!r.isAnnounced)return r=r||new Ke(void 0,e,!1,void 0),this._contextNameToData[e]=r,r.updateCallbacks[n]=t,Promise.resolve(n);var o=r.hasCallbacks();return r.updateCallbacks[n]=t,o||r.joinedActivity||r.context&&r.sentExplicitSubscription?(t(r.context,r.context,[],n),Promise.resolve(n)):this.sendSubscribe(r).then((function(){return n}))},e.prototype.unsubscribe=function(e){for(var t=0,n=Object.keys(this._contextNameToData);t<n.length;t++){var r=n[t],o=(this._contextNameToId[r],this._contextNameToData[r]);if(!o)return;var i=o.hasCallbacks();delete o.updateCallbacks[e],o.isAnnounced&&i&&!o.hasCallbacks()&&o.sentExplicitSubscription&&this.sendUnsubscribe(o),o.isAnnounced||o.hasCallbacks()||delete this._contextNameToData[r]}},e.prototype.handleUpdated=function(e,t,n){var r=e.context;e.context=Je(e.context,t),this._contextNameToData[e.name]!==e||ze(r,e.context)||this.invokeUpdateCallbacks(e,e.context,t,n)},e.prototype.subscribeToContextCreatedMessages=function(){for(var e=0,t=["context-added","context-created","created"];e<t.length;e++){var n=t[e],r=this._connection.on(n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(r)}},e.prototype.handleContextCreatedMessage=function(e){var t=e.type;"created"===t?(this._contextNameToId[e.activity_id]=e.context_id,this._contextIdToName[e.context_id]=e.activity_id):"context-added"===t&&(this._contextNameToId[e.name]=e.context_id,this._contextIdToName[e.context_id]=e.name);var n=this._contextIdToName[e.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+e.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+e.context_id);var r=this._contextNameToData[n];if(r){if(r.isAnnounced)return;if(!r.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");r.isAnnounced=!0,r.contextId=e.context_id,r.activityId=e.activity_id,r.sentExplicitSubscription||this.sendSubscribe(r)}else this._contextNameToData[n]=r=new Ke(e.context_id,n,!0,e.activity_id)},e.prototype.subscribeToContextUpdatedMessages=function(){for(var e=0,t=["context-updated","subscribed-context","joined"];e<t.length;e++){var n=t[e],r=this._connection.on(n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(r)}},e.prototype.handleContextUpdatedMessage=function(e){var t=e.type,n=e.context_id,r=this._contextNameToData[this._contextIdToName[n]],o=!r||!r.isAnnounced;if("joined"===t)r?(r.contextId=n,r.isAnnounced=!0,r.activityId=e.activity_id):(r=new Ke(n,e.activity_id,!0,e.activity_id),this._contextNameToData[e.activity_id]=r,this._contextIdToName[n]=e.activity_id,this._contextNameToId[e.activity_id]=n),r.joinedActivity=!0;else if(!r||!r.isAnnounced)return void("subscribed-context"===t?((r=r||new Ke(n,e.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[e.name]=r,this._contextIdToName[n]=e.name,this._contextNameToId[e.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var i=r.context;if("subscribed-context"===t)r.context=e.data||{};else if("joined"===t)r.context=e.context_snapshot||{};else{if("context-updated"!==t)throw new Error("Unrecognized context update message "+t);r.context=Je(r.context,e.delta)}!o&&ze(r.context,i)&&"subscribed-context"!==t||this.invokeUpdateCallbacks(r,r.context,e.delta,{updaterId:e.updater_id})},e.prototype.invokeUpdateCallbacks=function(e,t,n,r){for(var o in n=n||{added:{},updated:{},reset:{},removed:[]},e.updateCallbacks)if(e.updateCallbacks.hasOwnProperty(o))try{(0,e.updateCallbacks[o])(Ve(t),Object.assign({},n.added||{},n.updated||{},n.reset||{}),n.removed,parseInt(o,10),r)}catch(e){this._logger.debug("callback error: "+JSON.stringify(e))}},e.prototype.subscribeToContextDestroyedMessages=function(){for(var e=0,t=["context-destroyed","destroyed"];e<t.length;e++){var n=t[e],r=this._connection.on(n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(r)}},e.prototype.handleContextDestroyedMessage=function(e){var t,n;if("destroyed"===e.type){if(n=e.activity_id,!(t=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+e.activity_id)}else if(t=e.context_id,!(n=this._contextIdToName[t]))return void this._logger.error("Received 'destroyed' for unknown context: "+e.context_id);delete this._contextIdToName[t],delete this._contextNameToId[n];var r=this._contextNameToData[n];delete this._contextNameToData[n],r&&r.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+t)},e.prototype.sendSubscribe=function(e){return e.sentExplicitSubscription=!0,this._gw3Session.send({type:"subscribe-context",domain:"global",context_id:e.contextId}).then((function(e){}))},e.prototype.sendUnsubscribe=function(e){return e.sentExplicitSubscription=!1,this._gw3Session.send({type:"unsubscribe-context",domain:"global",context_id:e.contextId}).then((function(e){}))},e.prototype.calculateContextDelta=function(e,t){var n={added:{},updated:{},removed:[],reset:void 0};if(e)for(var r=0,o=Object.keys(e);r<o.length;r++){var i=o[r];-1===Object.keys(t).indexOf(i)||null===t[i]||ze(e[i],t[i])||(n.updated[i]=t[i])}for(var s=0,a=Object.keys(t);s<a.length;s++){i=a[s];e&&-1!==Object.keys(e).indexOf(i)?null===t[i]&&n.removed.push(i):null!==t[i]&&(n.added[i]=t[i])}return n},e}(),Qe=function(){function e(e){this._bridge=new Xe(e)}return e.prototype.all=function(){return this._bridge.all()},e.prototype.update=function(e,t){return this.checkName(e),this._bridge.update(e,t)},e.prototype.set=function(e,t){return this.checkName(e),this._bridge.set(e,t)},e.prototype.subscribe=function(e,t){var n=this;return this.checkName(e),this._bridge.subscribe(e,(function(e,r,o,i,s){return t(e,r,o,(function(){return n._bridge.unsubscribe(i)}),s)})).then((function(e){return function(){n._bridge.unsubscribe(e)}}))},e.prototype.get=function(e,t){return void 0===t&&(t=!0),this._bridge.get(e,t)},e.prototype.ready=function(){return Promise.resolve(this)},e.prototype.checkName=function(e){if("string"!=typeof e||""===e)throw new Error("'name' must be non-empty string, got '"+e+"'")},e}();function Ze(e,t,n){return"function"!=typeof t&&"function"!=typeof n?e:("function"!=typeof t?t=function(){}:"function"!=typeof n&&(n=function(){}),e.then(t,n))}function $e(e,t){return void 0===e&&(e=0),new Promise((function(n,r){return setTimeout((function(){return r(t)}),e)}))}!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(Ye||(Ye={}));var et=function(){function e(e,t,n,r){this.protocol=e,this.repo=t,this.instance=n,this.configuration=r}return e.prototype.subscribe=function(e,t,n,r,o){var i=this,s=function(e,n,r,s){var a;t.methodResponseTimeout=null!==(a=t.methodResponseTimeout)&&void 0!==a?a:t.waitTimeoutMs,i.protocol.client.subscribe(n,t,e,r,s,o)};return Ze(new Promise((function(n,r){var o,a=function(e){n(e)},c=function(e){r(e)};if(e)if((o="string"==typeof e?{name:e}:e).name){void 0===t&&(t={});var u=t.target;if(void 0===u&&(u="best"),"string"!=typeof u||"all"===u||"best"===u){void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=t.method_response_timeout,void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=i.configuration.methodResponseTimeout)),void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=t.wait_for_method_timeout,void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=i.configuration.waitTimeoutMs));var d=0,p=i.getServerMethodsByFilterAndTarget(o,u);if(p.length>0)s(p,p[0].methods[0],a,c);else{var h=function(){if(u&&t.waitTimeoutMs)if(d+=500,(p=i.getServerMethodsByFilterAndTarget(o,u)).length>0){var n=p[0].methods[0];s(p,n,a,c)}else if(d>=t.waitTimeoutMs){s(p,"string"==typeof e?{name:e}:e,a,c)}else setTimeout(h,500)};setTimeout(h,500)}}else r(new Error('"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else r("Method definition is required. Please, provide either a unique string for a method name or a âmethodDefinitionâ object with a required ânameâ property.");else r("Method definition is required. Please, provide either a unique string for a method name or a âmethodDefinitionâ object with a required ânameâ property.")})),n,r)},e.prototype.servers=function(e){var t=void 0===e?void 0:B({},e);return this.getServers(t).map((function(e){return e.server.instance}))},e.prototype.methods=function(e){var t=B({},e);return this.getMethods(t)},e.prototype.methodsForInstance=function(e){return this.getMethodsForInstance(e)},e.prototype.methodAdded=function(e){return this.repo.onMethodAdded(e)},e.prototype.methodRemoved=function(e){return this.repo.onMethodRemoved(e)},e.prototype.serverAdded=function(e){return this.repo.onServerAdded(e)},e.prototype.serverRemoved=function(e){return this.repo.onServerRemoved((function(t,n){e(t,n)}))},e.prototype.serverMethodAdded=function(e){return this.repo.onServerMethodAdded((function(t,n){e({server:t,method:n})}))},e.prototype.serverMethodRemoved=function(e){return this.repo.onServerMethodRemoved((function(t,n){e({server:t,method:n})}))},e.prototype.invoke=function(e,t,n,r,o,i){return H(this,void 0,void 0,(function(){var s=this;return U(this,(function(a){return[2,Ze(function(){return H(s,void 0,void 0,(function(){var o,i,s,a,c,u,d,p,h=this;return U(this,(function(l){switch(l.label){case 0:if(!(o="string"==typeof e?{name:e}:B({},e)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a âmethodDefinitionâ object with a required ânameâ property.")];if(t||(t={}),n||(n="best"),"string"==typeof n&&"all"!==n&&"best"!==n&&"skipMine"!==n)return[2,Promise.reject(new Error('"'+n+'" is not a valid target. Valid targets are "all" and "best".'))];if(r||(r={}),void 0===r.methodResponseTimeoutMs&&(r.methodResponseTimeoutMs=r.method_response_timeout,void 0===r.methodResponseTimeoutMs&&(r.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===r.waitTimeoutMs&&(r.waitTimeoutMs=r.wait_for_method_timeout,void 0===r.waitTimeoutMs&&(r.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==r.waitTimeoutMs&&"number"!=typeof r.waitTimeoutMs)return[2,Promise.reject(new Error('"'+r.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof t)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+o.name))];if(0!==(i=this.getServerMethodsByFilterAndTarget(o,n)).length)return[3,4];l.label=1;case 1:return l.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(o,n,r)];case 2:return i=l.sent(),[3,4];case 3:return l.sent(),s={method:o,called_with:t,message:"Can not find a method matching "+JSON.stringify(e)+" with server filter "+JSON.stringify(n)+". Is the object a valid instance ?",executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(s)];case 4:return a=r.methodResponseTimeoutMs,c=r,u=i.map((function(e){var n=Ee();return Promise.race([h.protocol.client.invoke(n,e.methods[0],t,e.server,c),$e(a,{invocationId:n,message:"Invocation timeout ("+a+" ms) reached",status:Ye.Error})])})),[4,Promise.all(u)];case 5:return d=l.sent(),p=this.getInvocationResultObj(d,o,t),d.every((function(e){return e.status===Ye.Error}))?[2,Promise.reject(p)]:[2,p]}}))}))}(),o,i)]}))}))},e.prototype.getInvocationResultObj=function(e,t,n){var r=e.filter((function(e){return e.status===Ye.Success})).reduce((function(e,r){return e=K(e,[{executed_by:r.instance,returned:r.result,called_with:n,method:t,message:r.message,status:r.status}])}),[]),o=e.filter((function(e){return e.status===Ye.Error})).reduce((function(e,r){return e=K(e,[{executed_by:r.instance,called_with:n,name:t.name,message:r.message}])}),[]),i=e[0];return{method:t,called_with:n,returned:i.result,executed_by:i.instance,all_return_values:r,all_errors:o,message:i.message,status:i.status}},e.prototype.tryToAwaitForMethods=function(e,t,n){var r=this;return new Promise((function(o,i){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=r.getServerMethodsByFilterAndTarget(e,t);if(c.length>0)clearInterval(a),o(c);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(a),void i()}),500);else i()}))},e.prototype.filterByTarget=function(e,t){var n=this;if("string"!=typeof e){return(Array.isArray(e)?e:[e]).reduce((function(e,r){var o=t.filter((function(e){return n.instanceMatch(r,e.server.instance)}));return e.concat(o)}),[])}if("all"===e)return K(t);if("best"===e){var r=t.find((function(e){return e.server.instance.isLocal}));if(r)return[r];if(void 0!==t[0])return[t[0]]}else if("skipMine"===e)return t.filter((function(e){return e.server.instance.peerId!==n.instance.peerId}));return[]},e.prototype.instanceMatch=function(e,t){return this.containsProps(e,t)},e.prototype.methodMatch=function(e,t){return this.containsProps(e,t)},e.prototype.containsProps=function(e,t){return Object.keys(e).filter((function(t){return void 0!==e[t]&&"function"!=typeof e[t]&&"object_types"!==t&&"display_name"!==t&&"id"!==t&&"gatewayId"!==t&&"identifier"!==t&&"_"!==t[0]})).reduce((function(n,r){var o=e[r],i=t[r];if("objectTypes"===r){(o.length>i.length||!1===function(e,t){var n=e.reduce((function(e,t){return e[t]=!1,e}),{});t.forEach((function(e){void 0!==n[e]&&(n[e]=!0)}));return Object.keys(n).reduce((function(e,t){return n[t]||(e=!1),e}),!0)}(o,i))&&(n=!1)}else String(o).toLowerCase()!==String(i).toLowerCase()&&(n=!1);return n}),!0)},e.prototype.getMethods=function(e){var t=this;return void 0===e?this.repo.getMethods():("string"==typeof e&&(e={name:e}),this.repo.getMethods().filter((function(n){return t.methodMatch(e,n)})))},e.prototype.getMethodsForInstance=function(e){var t=this,n=this.repo.getServers().filter((function(n){return t.instanceMatch(e,n.instance)}));if(0===n.length)return[];var r={};return 1===n.length?r=n[0].methods:n.forEach((function(e){Object.keys(e.methods).forEach((function(t){var n=e.methods[t];r[n.identifier]=n}))})),Object.keys(r).map((function(e){return r[e]}))},e.prototype.getServers=function(e){var t=this,n=this.repo.getServers();return void 0===e?n.map((function(e){return{server:e,methods:[]}})):n.reduce((function(n,r){var o=t.repo.getServerMethodsById(r.id).filter((function(n){return t.methodMatch(e,n)}));return o.length>0&&n.push({server:r,methods:o}),n}),[])},e.prototype.getServerMethodsByFilterAndTarget=function(e,t){var n=this.getServers(e);return this.filterByTarget(t,n)},e}(),tt=function(){function e(e,t,n){this.protocol=e,this.repoMethod=t,this.subscription=n}return Object.defineProperty(e.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),e.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},e.prototype.push=function(e){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,e)},e}(),nt=function(){function e(e,t,n){this.protocol=e,this.repoMethod=t,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return e.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},e.prototype.acceptOnBranch=function(e){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,e)},e.prototype.reject=function(e){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,e)},e}(),rt=function(){function e(e,t){var n=this;this.protocol=e,this.server=t,e.server.onSubRequest((function(e,t){return n.handleSubRequest(e,t)})),e.server.onSubAdded((function(e,t){return n.handleSubAdded(e,t)})),e.server.onSubRemoved((function(e,t){return n.handleSubRemoved(e,t)}))}return e.prototype.handleSubRequest=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionRequestHandler){var n=new nt(this.protocol,t,e);t.streamCallbacks.subscriptionRequestHandler(n)}},e.prototype.handleSubAdded=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionAddedHandler){var n=new tt(this.protocol,t,e);t.streamCallbacks.subscriptionAddedHandler(n)}},e.prototype.handleSubRemoved=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionRemovedHandler){var n=new tt(this.protocol,t,e);t.streamCallbacks.subscriptionRemovedHandler(n)}},e}(),ot=function(){function e(e,t,n){this.key=e,this.protocol=t,this.repoMethod=n}return e.prototype.subscriptions=function(){var e=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(t){return new tt(e.protocol,e.repoMethod,t)}))},e.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},e.prototype.push=function(e){this.protocol.server.pushData(this.repoMethod,e,[this.key])},e}(),it=function(){function e(e,t,n){this._protocol=e,this._repoMethod=t,this._server=n,this.name=this._repoMethod.definition.name}return e.prototype.branches=function(e){var t=this,n=this._protocol.server.getBranchList(this._repoMethod);return e?n.indexOf(e)>-1?new ot(e,this._protocol,this._repoMethod):void 0:n.map((function(e){return new ot(e,t._protocol,t._repoMethod)}))},e.prototype.branch=function(e){return this.branches(e)},e.prototype.subscriptions=function(){var e=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(t){return new tt(e._protocol,e._repoMethod,t)}))},Object.defineProperty(e.prototype,"definition",{get:function(){var e=this._repoMethod.definition;return{accepts:e.accepts,description:e.description,displayName:e.displayName,name:e.name,objectTypes:e.objectTypes,returns:e.returns,supportsStreaming:e.supportsStreaming}},enumerable:!0,configurable:!0}),e.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},e.prototype.push=function(e,t){if("string"!=typeof t&&!Array.isArray(t)&&void 0!==t)throw new Error("invalid branches should be string or string array");if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,e,t)},e.prototype.updateRepoMethod=function(e){this._repoMethod=e},e}(),st=function(){function e(e,t){this.protocol=e,this.serverRepository=t,this.invocations=0,this.currentlyUnregistering={},this.streaming=new rt(e,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return e.prototype.createStream=function(e,t,n,r,o){var i=this;return Ze(new Promise((function(n,r){if(e){var s;if(!(s="string"==typeof e?{name:""+e}:B({},e)).name)return r("The ânameâ property is required for the âstreamDefinitionâ object and must be unique. Stream definition: "+JSON.stringify(s));if(i.serverRepository.getList().some((function(e){return e.definition.name===s.name})))return r('A stream with the name "'+s.name+'" already exists! Please, provide a unique name for the stream.');s.supportsStreaming=!0,t||(t={}),"function"!=typeof t.subscriptionRequestHandler&&(t.subscriptionRequestHandler=function(e){e.accept()});var a=i.serverRepository.add({definition:s,streamCallbacks:t,protocolState:{}});i.protocol.server.createStream(a).then((function(){var e;o?(e=o,o.updateRepoMethod(a)):e=new it(i.protocol,a,i),a.stream=e,n(e)})).catch((function(e){a.repoId&&i.serverRepository.remove(a.repoId),r(e)}))}else r("The stream name must be unique! Please, provide either a unique string for a stream name to âglue.interop.createStream()â or a âmethodDefinitionâ object with a unique ânameâ property for the stream.")})),n,r)},e.prototype.register=function(e,t){var n=this;if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a âmethodDefinitionâ object with a required ânameâ property.");if("function"!=typeof t)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof e?e:e.name));var r=function(e,r){return H(n,void 0,void 0,(function(){var n,o,i;return U(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),(n=t(e.args,e.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return o=s.sent(),r(void 0,o),[3,3];case 2:r(void 0,n),s.label=3;case 3:return[3,5];case 4:return(i=s.sent())||(i=""),r(i,i),[3,5];case 5:return[2]}}))}))};return r.userCallback=t,this.registerCore(e,r)},e.prototype.registerAsync=function(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a âmethodDefinitionâ object with a required ânameâ property.");if("function"!=typeof t)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof e?e:e.name));var n=function(e,n){try{var r=!1,o=function(e){r||n(void 0,e),r=!0},i=function(e){r||(e||(e=""),n(e,e)),r=!0},s=t(e.args,e.instance,o,i);s&&"function"==typeof s.then&&s.then(o).catch(i)}catch(e){n(e,void 0)}};return n.userCallbackAsync=t,this.registerCore(e,n)},e.prototype.unregister=function(e,t){return void 0===t&&(t=!1),H(this,void 0,void 0,(function(){var n,r;return U(this,(function(o){switch(o.label){case 0:return void 0===e?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a ânameâ property.")]:"function"!=typeof e?[3,2]:[4,this.unregisterWithPredicate(e,t)];case 1:return o.sent(),[2];case 2:return void 0===(n="string"==typeof e?{name:e}:e).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(r=this.serverRepository.getList().find((function(e){return e.definition.name===n.name&&(e.definition.supportsStreaming||!1)===t})))?[4,this.removeMethodsOrStreams([r])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return o.sent(),[2]}}))}))},e.prototype.unregisterWithPredicate=function(e,t){return H(this,void 0,void 0,(function(){var n;return U(this,(function(r){switch(r.label){case 0:return(n=this.serverRepository.getList().filter((function(t){return e(t.definition)})).filter((function(e){return(e.definition.supportsStreaming||!1)===t})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(t?"stream":"method")+" matching the specified condition!")];case 1:return r.sent(),[2]}}))}))},e.prototype.removeMethodsOrStreams=function(e){var t=this,n=[];return e.forEach((function(e){var r=t.protocol.server.unregister(e).then((function(){e.repoId&&t.serverRepository.remove(e.repoId)}));n.push(r),t.addAsCurrentlyUnregistering(e.definition.name,r)})),Promise.all(n)},e.prototype.addAsCurrentlyUnregistering=function(e,t){return H(this,void 0,void 0,(function(){var n,r=this;return U(this,(function(o){return n=new Promise((function(e){return setTimeout(e,5e3)})),this.currentlyUnregistering[e]=Promise.race([t,n]).then((function(){delete r.currentlyUnregistering[e]})),[2]}))}))},e.prototype.registerCore=function(e,t){return H(this,void 0,void 0,(function(){var n,r,o,i=this;return U(this,(function(s){switch(s.label){case 0:return(n="string"==typeof e?{name:""+e}:B({},e)).name?(r=this.currentlyUnregistering[n.name])?[4,r]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the ânameâ property in the âmethodDefinitionâ object: "+JSON.stringify(e))];case 1:s.sent(),s.label=2;case 2:return this.serverRepository.getList().some((function(e){return e.definition.name===n.name}))?[2,Promise.reject('A method with the name "'+n.name+'" already exists! Please, provide a unique name for the method.')]:n.supportsStreaming?[2,Promise.reject("When you create methods with âglue.interop.register()â or âglue.interop.registerAsync()â the property âsupportsStreamingâ cannot be âtrueâ. If you want â"+n.name+"â to be a stream, please use the âglue.interop.createStream()â method.")]:(o=this.serverRepository.add({definition:n,theFunction:t,protocolState:{}}),[2,this.protocol.server.register(o).catch((function(e){throw(null==o?void 0:o.repoId)&&i.serverRepository.remove(o.repoId),e}))])}}))}))},e.prototype.onMethodInvoked=function(e,t,n){var r=this;e&&e.theFunction&&e.theFunction(n,(function(n,o){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(e){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}o?("object"!=typeof o||Array.isArray(o))&&(o={_value:o}):o={},r.protocol.server.methodInvocationResult(e,t,n,o)}))},e}(),at=function(){function e(e,t){var n=this;this.wrapped={getMethods:ct,getStreams:ut},e&&this.refreshWrappedObject(e),t&&(t.loggedIn((function(){n.refresh(t)})),this.refresh(t))}return e.prototype.unwrap=function(){return this.wrapped},e.prototype.refresh=function(e){if(e){var t=null==e?void 0:e.resolvedIdentity,n=Object.assign({},null!=t?t:{},{peerId:null==e?void 0:e.peerId});this.refreshWrappedObject(n)}},e.prototype.refreshWrappedObject=function(e){var t,n,r;this.wrapped.user=e.user,this.wrapped.instance=e.instance,this.wrapped.application=null!==(t=e.application)&&void 0!==t?t:Ee(),this.wrapped.applicationName=e.applicationName,this.wrapped.pid=null!==(r=null!==(n=e.pid)&&void 0!==n?n:e.process)&&void 0!==r?r:Math.floor(1e10*Math.random()),this.wrapped.machine=e.machine,this.wrapped.environment=e.environment,this.wrapped.region=e.region,this.wrapped.windowId=e.windowId,this.wrapped.isLocal=!0,this.wrapped.api=e.api,this.wrapped.service=e.service,this.wrapped.peerId=e.peerId},e}();function ct(){var e;return null===(e=at.API)||void 0===e?void 0:e.methodsForInstance(this)}function ut(){var e;return null===(e=at.API)||void 0===e?void 0:e.methodsForInstance(this).filter((function(e){return e.supportsStreaming}))}var dt=function(){function e(e){this.logger=e,this.servers={},this.methodsCount={},this.callbacks=pe()}return e.prototype.addServer=function(e,t){this.logger.debug("adding server "+t);var n=this.servers[t];if(n)return n.id;var r=new at(e),o={id:t,methods:{},instance:r.unwrap(),wrapper:r};return this.servers[t]=o,this.callbacks.execute("onServerAdded",o.instance),t},e.prototype.removeServerById=function(e,t){var n=this,r=this.servers[e];r?(this.logger.debug("removing server "+e),Object.keys(r.methods).forEach((function(t){n.removeServerMethod(e,t)})),delete this.servers[e],this.callbacks.execute("onServerRemoved",r.instance,t)):this.logger.warn("not aware of server "+e+", my state "+JSON.stringify(Object.keys(this.servers)))},e.prototype.addServerMethod=function(e,t){var n=this.servers[e];if(!n)throw new Error("server does not exists");if(!n.methods[t.id]){var r=this.createMethodIdentifier(t),o={identifier:r,gatewayId:t.id,name:t.name,displayName:t.display_name,description:t.description,version:t.version,objectTypes:t.object_types||[],accepts:t.input_signature,returns:t.result_signature,supportsStreaming:void 0!==t.flags&&t.flags.streaming};o.object_types=o.objectTypes,o.display_name=o.displayName,o.version=o.version;var i=this;return o.getServers=function(){return i.getServersByMethod(t.id)},n.methods[t.id]=o,this.methodsCount[r]||(this.methodsCount[r]=0,this.callbacks.execute("onMethodAdded",o)),this.methodsCount[r]=this.methodsCount[r]+1,this.callbacks.execute("onServerMethodAdded",n.instance,o),o}},e.prototype.removeServerMethod=function(e,t){var n=this.servers[e];if(!n)throw new Error("server does not exists");var r=n.methods[t];delete n.methods[t],this.methodsCount[r.identifier]=this.methodsCount[r.identifier]-1,0===this.methodsCount[r.identifier]&&this.callbacks.execute("onMethodRemoved",r),this.callbacks.execute("onServerMethodRemoved",n.instance,r)},e.prototype.getMethods=function(){var e=this,t={};return Object.keys(this.servers).forEach((function(n){var r=e.servers[n];Object.keys(r.methods).forEach((function(e){var n=r.methods[e];t[n.identifier]=n}))})),Object.keys(t).map((function(e){return t[e]}))},e.prototype.getServers=function(){var e=this,t=[];return Object.keys(this.servers).forEach((function(n){var r=e.servers[n];t.push(r)})),t},e.prototype.getServerMethodsById=function(e){var t=this.servers[e];return Object.keys(t.methods).map((function(e){return t.methods[e]}))},e.prototype.onServerAdded=function(e){var t=this.callbacks.add("onServerAdded",e),n=this.getServers().map((function(e){return e.instance}));return this.returnUnsubWithDelayedReplay(t,n,e)},e.prototype.onMethodAdded=function(e){var t=this.callbacks.add("onMethodAdded",e),n=this.getMethods();return this.returnUnsubWithDelayedReplay(t,n,e)},e.prototype.onServerMethodAdded=function(e){var t=this.callbacks.add("onServerMethodAdded",e),n=!1,r=this.getServers();return setTimeout((function(){r.forEach((function(t){var r=t.methods;Object.keys(r).forEach((function(o){n||e(t.instance,r[o])}))}))}),0),function(){n=!0,t()}},e.prototype.onMethodRemoved=function(e){return this.callbacks.add("onMethodRemoved",e)},e.prototype.onServerRemoved=function(e){return this.callbacks.add("onServerRemoved",e)},e.prototype.onServerMethodRemoved=function(e){return this.callbacks.add("onServerMethodRemoved",e)},e.prototype.getServerById=function(e){return this.servers[e]},e.prototype.reset=function(){var e=this;Object.keys(this.servers).forEach((function(t){e.removeServerById(t,"reset")})),this.servers={},this.methodsCount={}},e.prototype.createMethodIdentifier=function(e){var t=void 0!==e.input_signature?e.input_signature:"",n=void 0!==e.result_signature?e.result_signature:"";return(e.name+t+n).toLowerCase()},e.prototype.getServersByMethod=function(e){var t=this,n=[];return Object.keys(this.servers).forEach((function(r){var o=t.servers[r];Object.keys(o.methods).forEach((function(t){t===e&&n.push(o.instance)}))})),n},e.prototype.returnUnsubWithDelayedReplay=function(e,t,n){var r=!1;return setTimeout((function(){t.forEach((function(e){r||n(e)}))}),0),function(){r=!0,e()}},e}(),pt=function(){function e(){this.nextId=0,this.methods=[]}return e.prototype.add=function(e){return e.repoId=String(this.nextId),this.nextId+=1,this.methods.push(e),e},e.prototype.remove=function(e){if("string"!=typeof e)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(t){return t.repoId!==e}))},e.prototype.getById=function(e){if("string"==typeof e)return this.methods.find((function(t){return t.repoId===e}))},e.prototype.getList=function(){return this.methods.map((function(e){return e}))},e.prototype.length=function(){return this.methods.length},e.prototype.reset=function(){this.methods=[]},e}(),ht=function(){function e(e,t,n){var r=this;this.session=e,this.repository=t,this.serverRepository=n,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=pe(),this.nextStreamId=0,e.on("add-interest",(function(e){r.handleAddInterest(e)})),e.on("remove-interest",(function(e){r.handleRemoveInterest(e)}))}return e.prototype.acceptRequestOnBranch=function(e,t,n){if("string"!=typeof n&&(n=""),"object"!=typeof t.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(t.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var r=this.getStreamId(t,n),o=e.msg.subscription_id,i={id:o,arguments:e.arguments,instance:e.instance,branchKey:n,streamId:r,subscribeMsg:e.msg};t.protocolState.subscriptionsMap[o]=i,this.session.sendFireAndForget({type:"accepted",subscription_id:o,stream_id:r}),this.callbacks.execute("onSubscriptionAdded",i,t)},e.prototype.rejectRequest=function(e,t,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,e.msg.subscription_id)},e.prototype.pushData=function(e,t,n){var r=this;if("object"==typeof e&&Array.isArray(e.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]),e.protocolState.branchKeyToStreamIdMap.filter((function(e){return!n||0===n.length||n.indexOf(e.key)>=0})).map((function(e){return e.streamId})).forEach((function(e){var n={type:"publish",stream_id:e,data:t};r.session.sendFireAndForget(n)}))}},e.prototype.pushDataToSingle=function(e,t,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var r={type:"post",subscription_id:t.id,data:n};this.session.sendFireAndForget(r)},e.prototype.closeSingleSubscription=function(e,t){e.protocolState.subscriptionsMap&&delete e.protocolState.subscriptionsMap[t.id];var n={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);t.instance;this.callbacks.execute("onSubscriptionRemoved",t,e)},e.prototype.closeMultipleSubscriptions=function(e,t){var n=this;if("object"==typeof e&&"object"==typeof e.protocolState.subscriptionsMap&&e.protocolState.subscriptionsMap){var r=e.protocolState.subscriptionsMap,o=Object.keys(r).map((function(e){return r[e]}));"string"==typeof t&&(o=o.filter((function(e){return e.branchKey===t}))),o.forEach((function(e){delete r[e.id];var t={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping all subscriptions on stream_id: "+e.streamId};n.session.sendFireAndForget(t)}))}},e.prototype.getSubscriptionList=function(e,t){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];var n=e.protocolState.subscriptionsMap,r=Object.keys(n).map((function(e){return n[e]}));return"string"!=typeof t?r:r.filter((function(e){return e.branchKey===t}))},e.prototype.getBranchList=function(e){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];var t=e.protocolState.subscriptionsMap,n=Object.keys(t).map((function(e){return t[e]})),r=[];return n.forEach((function(e){var t="";"object"==typeof e&&"string"==typeof e.branchKey&&(t=e.branchKey),-1===r.indexOf(t)&&r.push(t)})),r},e.prototype.onSubAdded=function(e){this.onSubscriptionLifetimeEvent("onSubscriptionAdded",e)},e.prototype.onSubRequest=function(e){this.onSubscriptionLifetimeEvent("onSubscriptionRequest",e)},e.prototype.onSubRemoved=function(e){this.onSubscriptionLifetimeEvent("onSubscriptionRemoved",e)},e.prototype.handleRemoveInterest=function(e){var t=this.serverRepository.getById(e.method_id);if("string"==typeof e.subscription_id&&"object"==typeof t&&t.protocolState.subscriptionsMap&&"object"==typeof t.protocolState.subscriptionsMap[e.subscription_id]){var n=t.protocolState.subscriptionsMap[e.subscription_id];delete t.protocolState.subscriptionsMap[e.subscription_id],this.callbacks.execute("onSubscriptionRemoved",n,t)}},e.prototype.onSubscriptionLifetimeEvent=function(e,t){this.callbacks.add(e,t)},e.prototype.getNextStreamId=function(){return this.nextStreamId+++""},e.prototype.handleAddInterest=function(e){var t=this.repository.getServerById(e.caller_id).instance,n={msg:e,arguments:e.arguments_kv||{},instance:t},r=this.serverRepository.getById(e.method_id);if(void 0!==r)r.protocolState.subscriptionsMap&&r.protocolState.subscriptionsMap[e.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+e.subscription_id+" already exists.",e.subscription_id):this.callbacks.execute("onSubscriptionRequest",n,r);else{var o="No method with id "+e.method_id+" on this server.";this.sendSubscriptionFailed(o,e.subscription_id)}},e.prototype.sendSubscriptionFailed=function(e,t){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:e,request_id:t};this.session.sendFireAndForget(n)},e.prototype.getStreamId=function(e,t){if("string"!=typeof t&&(t=""),!e.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+e.definition.name+" method without protocol state");var n=e.protocolState.branchKeyToStreamIdMap.filter((function(e){return e.key===t}))[0],r=n?n.streamId:void 0;return"string"==typeof r&&""!==r||(r=this.getNextStreamId(),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:r})),r},e}(),lt=function(){function e(e,t,n,r){var o=this;this.session=e,this.clientRepository=t,this.serverRepository=n,this.logger=r,this.callbacks=pe(),this.streaming=new ht(e,t,n),this.session.on("invoke",(function(e){return o.handleInvokeMessage(e)}))}return e.prototype.createStream=function(e){return e.protocolState.subscriptionsMap={},e.protocolState.branchKeyToStreamIdMap=[],this.register(e,!0)},e.prototype.register=function(e,t){var n=this,r=e.definition,o={streaming:t||!1},i={type:"register",methods:[{id:e.repoId,name:r.name,display_name:r.displayName,description:r.description,version:r.version,flags:o,object_types:r.objectTypes||r.object_types,input_signature:r.accepts,result_signature:r.returns,restrictions:void 0}]};return this.session.send(i,{methodId:e.repoId}).then((function(){n.logger.debug("registered method "+e.definition.name+" with id "+e.repoId)})).catch((function(t){throw n.logger.warn("failed to register method "+e.definition.name+" with id "+e.repoId+" - "+JSON.stringify(t)),t}))},e.prototype.onInvoked=function(e){this.callbacks.add("onInvoked",e)},e.prototype.methodInvocationResult=function(e,t,n,r){var o;o=n||""===n?{type:"error",request_id:t,reason_uri:"agm.errors.client_error",reason:n,context:r,peer_id:void 0}:{type:"yield",invocation_id:t,peer_id:this.session.peerId,result:r,request_id:void 0},this.session.sendFireAndForget(o)},e.prototype.unregister=function(e){return H(this,void 0,void 0,(function(){var t;return U(this,(function(n){switch(n.label){case 0:return t={type:"unregister",methods:[e.repoId]},[4,this.session.send(t)];case 1:return n.sent(),[2]}}))}))},e.prototype.getBranchList=function(e){return this.streaming.getBranchList(e)},e.prototype.getSubscriptionList=function(e,t){return this.streaming.getSubscriptionList(e,t)},e.prototype.closeAllSubscriptions=function(e,t){this.streaming.closeMultipleSubscriptions(e,t)},e.prototype.pushData=function(e,t,n){this.streaming.pushData(e,t,n)},e.prototype.pushDataToSingle=function(e,t,n){this.streaming.pushDataToSingle(e,t,n)},e.prototype.closeSingleSubscription=function(e,t){this.streaming.closeSingleSubscription(e,t)},e.prototype.acceptRequestOnBranch=function(e,t,n){this.streaming.acceptRequestOnBranch(e,t,n)},e.prototype.rejectRequest=function(e,t,n){this.streaming.rejectRequest(e,t,n)},e.prototype.onSubRequest=function(e){this.streaming.onSubRequest(e)},e.prototype.onSubAdded=function(e){this.streaming.onSubAdded(e)},e.prototype.onSubRemoved=function(e){this.streaming.onSubRemoved(e)},e.prototype.handleInvokeMessage=function(e){var t=e.invocation_id,n=e.caller_id,r=e.method_id,o=e.arguments_kv,i=this.serverRepository.getList().filter((function(e){return e.repoId===r}))[0];if(void 0!==i){var s={args:o,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",i,t,s)}},e}(),ft=function(){function e(e,t){this.repository=e,this.subscriptionData=t}return Object.defineProperty(e.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"servers",{get:function(){var e=this;return this.subscriptionData.trackedServers.filter((function(e){return e.subscriptionId})).map((function(t){return e.repository.getServerById(t.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),e.prototype.onData=function(e){if("function"!=typeof e)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(e),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(t){e(t)}))},e.prototype.onClosed=function(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(e)},e.prototype.onFailed=function(e){},e.prototype.onConnected=function(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(e)},e.prototype.close=function(){this.subscriptionData.close()},e.prototype.setNewSubscription=function(e){this.subscriptionData=e},e}(),vt=function(){function e(e,t,n){var r=this;this.session=e,this.repository=t,this.logger=n,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(e){var t=e._tag,n=t.subLocalKey,o=r.subscriptionsList[n];if("object"==typeof o&&(o.trackedServers=o.trackedServers.filter((function(e){return e.serverId!==t.serverId})),o.trackedServers.length<=0)){if(clearTimeout(o.timeoutId),"awaitingAccept"===o.status){var i="string"==typeof e.reason&&""!==e.reason?' Publisher said "'+e.reason+'".':" No reason given.",s="object"==typeof o.params.arguments?JSON.stringify(o.params.arguments):"{}";o.error({message:"Subscription rejected."+i+" Called with:"+s,called_with:o.params.arguments,method:o.method})}else"subscribed"===o.status&&r.callOnClosedHandlers(o);delete r.subscriptionsList[n]}},this.handleSubscribed=function(e){var t=e._tag.subLocalKey,n=r.subscriptionsList[t];if("object"==typeof n){var o=e._tag.serverId,i=n.trackedServers.filter((function(e){return e.serverId===o}))[0];if("object"==typeof i){i.subscriptionId=e.subscription_id,r.subscriptionIdToLocalKeyMap[e.subscription_id]=t;var s="awaitingAccept"===n.status;if(n.status="subscribed",s){var a=!1,c=n.subscription;c?(c.setNewSubscription(n),n.success(c),a=!0):(c=new ft(r.repository,n),n.subscription=c,n.success(c));for(var u=0,d=n.handlers.onConnected;u<d.length;u++){var p=d[u];try{p(c.serverInstance,a)}catch(e){}}}}}},this.handleEventData=function(e){var t=r.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0!==t){var n=r.subscriptionsList[t];if("object"==typeof n){var o=n.trackedServers.filter((function(t){return t.subscriptionId===e.subscription_id}));if(1===o.length){var i=e.oob,s=o[0].serverId,a=function(){return{data:e.data,server:r.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:i}},c=n.handlers.onData,u=n.queued.data;c.length>0?c.forEach((function(e){"function"==typeof e&&e(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(e){var t=r.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0!==t){var n=r.subscriptionsList[t];if("object"==typeof n){var o=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(t){return t.subscriptionId!==e.subscription_id||(n.queued.closers.push(t.serverId),!1)})),n.trackedServers.length===o&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),r.callOnClosedHandlers(n),delete r.subscriptionsList[t]),delete r.subscriptionIdToLocalKeyMap[e.subscription_id])}}},e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}return e.prototype.subscribe=function(e,t,n,r,o,i){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,e,t,r,o,t.methodResponseTimeout||1e4,i);"object"==typeof c?n.forEach((function(n){var r=n.server.id,o=n.methods.find((function(t){return t.name===e.name}));if(o){c.trackedServers.push({serverId:r,subscriptionId:void 0});var i={type:"subscribe",server_id:r,method_id:o.gatewayId,arguments_kv:t.arguments};s.session.send(i,{serverId:r,subLocalKey:a}).then((function(e){return s.handleSubscribed(e)})).catch((function(e){return s.handleErrorSubscribing(e)}))}else s.logger.error("can not find method "+e.name+" for target "+n.server.id)})):o({method:e,called_with:t.arguments,message:"Subscription failed. Unable to register the user callbacks."})}else o({method:e,called_with:t.arguments,message:"Subscription failed. No available servers matched the target params."})},e.prototype.drainSubscriptions=function(){var e=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},e},e.prototype.getNextSubscriptionLocalKey=function(){var e=this.nextSubLocalKey;return this.nextSubLocalKey+=1,e},e.prototype.registerSubscription=function(e,t,n,r,o,i,s){var a=this,c={localKey:e,status:"awaitingAccept",method:t,params:n,success:r,error:o,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(e)},subscription:null==s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[e]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[e]){var r=a.subscriptionsList[e];"awaitingAccept"===r.status?(o({method:t,called_with:n.arguments,message:"Subscription failed. Subscription attempt timed out after "+i+" ms."}),delete a.subscriptionsList[e]):"subscribed"===r.status&&r.trackedServers.length>0&&(r.trackedServers=r.trackedServers.filter((function(e){return void 0!==e.subscriptionId})),delete r.timeoutId,r.trackedServers.length<=0&&(a.callOnClosedHandlers(r),delete a.subscriptionsList[e]))}}),i),c},e.prototype.callOnClosedHandlers=function(e,t){var n,r=e.queued.closers.length,o=r>0?e.queued.closers[r-1]:null;void 0!==o&&"string"==typeof o&&(n=this.repository.getServerById(o).instance),e.handlers.onClosed.forEach((function(r){"function"==typeof r&&r({message:t||"ServerInitiated",requestArguments:e.params.arguments||{},server:n,stream:e.method})}))},e.prototype.closeSubscription=function(e){var t=this,n=this.subscriptionsList[e];"object"==typeof n&&(n.trackedServers.forEach((function(e){void 0!==e.subscriptionId&&(n.queued.closers.push(e.serverId),t.session.sendFireAndForget({type:"unsubscribe",subscription_id:e.subscriptionId,reason_uri:"",reason:"ClientInitiated"}),delete t.subscriptionIdToLocalKeyMap[e.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,"ClientInitiated"),delete this.subscriptionsList[e])},e}(),gt=function(){function e(e,t,n){var r=this;this.session=e,this.repository=t,this.logger=n,e.on("peer-added",(function(e){return r.handlePeerAdded(e)})),e.on("peer-removed",(function(e){return r.handlePeerRemoved(e)})),e.on("methods-added",(function(e){return r.handleMethodsAddedMessage(e)})),e.on("methods-removed",(function(e){return r.handleMethodsRemovedMessage(e)})),this.streaming=new vt(e,t,n)}return e.prototype.subscribe=function(e,t,n,r,o,i){this.streaming.subscribe(e,t,n,r,o,i)},e.prototype.invoke=function(e,t,n,r){var o=this,i=r.id,s={type:"call",server_id:i,method_id:t.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:e,serverId:i}).then((function(e){return o.handleResultMessage(e)})).catch((function(e){return o.handleInvocationError(e)}))},e.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},e.prototype.handlePeerAdded=function(e){var t=e.new_peer_id,n=e.identity,r=!e.meta||e.meta.local,o=Number(n.process),i={machine:n.machine,pid:isNaN(o)?n.process:o,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:t,api:n.api,isLocal:r};this.repository.addServer(i,t)},e.prototype.handlePeerRemoved=function(e){var t=e.removed_id,n=e.reason;this.repository.removeServerById(t,n)},e.prototype.handleMethodsAddedMessage=function(e){var t=this,n=e.server_id;e.methods.forEach((function(e){t.repository.addServerMethod(n,e)}))},e.prototype.handleMethodsRemovedMessage=function(e){var t=this,n=e.server_id,r=e.methods,o=this.repository.getServerById(n);Object.keys(o.methods).forEach((function(e){var i=o.methods[e];r.indexOf(i.gatewayId)>-1&&t.repository.removeServerMethod(n,e)}))},e.prototype.handleResultMessage=function(e){var t=e._tag.invocationId,n=e.result,r=e._tag.serverId;return{invocationId:t,result:n,instance:this.repository.getServerById(r).instance,status:Ye.Success,message:""}},e.prototype.handleInvocationError=function(e){this.logger.debug("handle invocation error "+JSON.stringify(e));var t=e._tag.invocationId,n=e._tag.serverId,r=this.repository.getServerById(n),o=e.reason;return{invocationId:t,result:e.context,instance:r.instance,status:Ye.Error,message:o}},e}();function mt(e,t,n,r,o,i){var s,a=o.logger.subLogger("gw3-protocol"),c=new Promise((function(e){s=e})),u=t.domain("agm",["subscribed"]),d=new lt(u,n,r,a.subLogger("server")),p=new gt(u,n,a.subLogger("client"));return u.onJoined((function(o){n.addServer(e,t.peerId),o?function(){a.info("reconnected - will replay registered methods and subscriptions");for(var e=0,t=p.drainSubscriptions();e<t.length;e++){var n=t[e],o=n.method,s=Object.assign({},n.params);a.info("trying to re-subscribe to method "+o.name),i.client.subscribe(o,s,void 0,void 0,n)}var c=r.getList();r.reset();for(var u=0,d=c;u<d.length;u++){var h=d[u],l=h.definition;a.info("re-publishing method "+l.name),h.stream?i.server.createStream(l,h.streamCallbacks,void 0,void 0,h.stream):h.theFunction&&h.theFunction.userCallback?i.register(l,h.theFunction.userCallback):h.theFunction&&h.theFunction.userCallbackAsync&&i.registerAsync(l,h.theFunction.userCallbackAsync)}}():s&&(s({client:p,server:d}),s=void 0)})),u.onLeft((function(){n.reset()})),u.join(),c}var yt=function(){function e(e){var t=this;if(void 0===e)throw new Error("configuration is required");if(void 0===e.connection)throw new Error("configuration.connections is required");var n,r=e.connection;if("number"!=typeof e.methodResponseTimeout&&(e.methodResponseTimeout=3e4),"number"!=typeof e.waitTimeoutMs&&(e.waitTimeoutMs=3e4),at.API=this,this.instance=new at(void 0,r).unwrap(),this.clientRepository=new dt(e.logger.subLogger("cRep")),this.serverRepository=new pt,3!==r.protocolVersion)throw new Error("protocol "+r.protocolVersion+" not supported");n=mt(this.instance,r,this.clientRepository,this.serverRepository,e,this),this.readyPromise=n.then((function(n){return t.protocol=n,t.client=new et(t.protocol,t.clientRepository,t.instance,e),t.server=new st(t.protocol,t.serverRepository),t}))}return e.prototype.ready=function(){return this.readyPromise},e.prototype.serverRemoved=function(e){return this.client.serverRemoved(e)},e.prototype.serverAdded=function(e){return this.client.serverAdded(e)},e.prototype.serverMethodRemoved=function(e){return this.client.serverMethodRemoved(e)},e.prototype.serverMethodAdded=function(e){return this.client.serverMethodAdded(e)},e.prototype.methodRemoved=function(e){return this.client.methodRemoved(e)},e.prototype.methodAdded=function(e){return this.client.methodAdded(e)},e.prototype.methodsForInstance=function(e){return this.client.methodsForInstance(e)},e.prototype.methods=function(e){return this.client.methods(e)},e.prototype.servers=function(e){return this.client.servers(e)},e.prototype.subscribe=function(e,t,n,r){return this.client.subscribe(e,t,n,r)},e.prototype.createStream=function(e,t,n,r){return this.server.createStream(e,t,n,r)},e.prototype.unregister=function(e){return this.server.unregister(e)},e.prototype.registerAsync=function(e,t){return this.server.registerAsync(e,t)},e.prototype.register=function(e,t){return this.server.register(e,t)},e.prototype.invoke=function(e,t,n,r,o,i){return this.client.invoke(e,t,n,r,o,i)},e}(),bt=["subscribed","success"],wt=function(){function e(e,t){var n=this;this.publish=function(e,t,r){var o=r||{},i=o.routingKey,s=o.target,a=n.removeEmptyValues({type:"publish",topic:e,data:t,peer_id:n.peerId,routing_key:i,target_identity:s});n.session.send(a)},this.subscribe=function(e,t,r){return new Promise((function(o,i){var s=r||{},a=s.routingKey,c=s.target,u=n.removeEmptyValues({type:"subscribe",topic:e,peer_id:n.peerId,routing_key:a,source:c});n.session.send(u).then((function(r){var i=r.subscription_id;n.subscriptions.push({subscription_id:i,topic:e,callback:t,source:c}),o({unsubscribe:function(){return n.session.send({type:"unsubscribe",subscription_id:i,peer_id:n.peerId}),n.subscriptions=n.subscriptions.filter((function(e){return e.subscription_id!==i})),Promise.resolve()}})})).catch((function(e){return i(e)}))}))},this.watchOnEvent=function(){n.session.on("event",(function(e){var t=e.data,r=e.subscription_id,o=e["publisher-identity"],i=n.subscriptions.find((function(e){return e.subscription_id===r}));i&&(i.source?n.keysMatch(i.source,o)&&i.callback(t,i.topic,o):i.callback(t,i.topic,o))}))},this.connection=e,this.logger=t,this.peerId=e.peerId,this.subscriptions=[],this.session=e.domain("bus",bt),this.readyPromise=this.session.join(),this.readyPromise.then((function(){n.watchOnEvent()}))}return e.prototype.ready=function(){return this.readyPromise},e.prototype.removeEmptyValues=function(e){var t={};return Object.keys(e).forEach((function(n){void 0!==e[n]&&null!==e[n]&&(t[n]=e[n])})),t},e.prototype.keysMatch=function(e,t){var n=Object.keys(e),r=!0;return n.forEach((function(n){e[n]!==t[n]&&(r=!1)})),r},e}(),St=function(e,t){var n,r=fe.getGDMajorVersion(),o=Promise.resolve();if(r){if(r<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");r>=3&&(n=window.glue42gd,o=window.gdPreloadPromise||o)}var i,s,a,c,u,d,p=Ue(),h=He(e=e||{},t=t||{},n),l={};function f(e,t,n){a.canPublish("trace")&&a.trace("registering "+e+" module");var r=function(){t.initTime=n.stop(),t.initEndTime=n.endTime,a.trace(e+" is ready")};t.initStartTime=n.startTime,t.ready?t.ready().then((function(){r()})):r(),Array.isArray(e)||(e=[e]),e.forEach((function(e){l[e]=t,St[e]=t}))}function v(){var e=Ue(),t=h.metrics,n=ue({connection:t?i:void 0,logger:a.subLogger("metrics")}),r=n;return r="boolean"!=typeof t&&t.disableAutoAppSystem?n:n.subSystem("App"),f("metrics",c=function(e){var t,n=e.subSystem("reporting"),r={name:"features"};return e.featureMetric=function(e,o,i){if(void 0===e||""===e)throw new Error("name is mandatory");if(void 0===o||""===o)throw new Error("action is mandatory");if(void 0===i||""===i)throw new Error("payload is mandatory");t?t.update({name:e,action:o,payload:i}):t=n.objectMetric(r,{name:e,action:o,payload:i})},e}(r),e),Promise.resolve()}function g(){var e=h.activities&&3===i.protocolVersion;if(h.contexts||e){var t=Ue();return f("contexts",u=new Qe({connection:i,logger:a.subLogger("contexts")}),t),u}var n=i.replayer;n&&n.drain(Be.name)}function m(){return H(this,void 0,void 0,(function(){var e;return U(this,(function(t){return h.bus?(e=Ue(),f("bus",d=new wt(i,a.subLogger("bus")),e),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function y(e){try{return e.forEach((function(e){!function(e,t){var n=Ue(),r=t(l);r&&f(e,r,n)}(e.name,e.create)})),Promise.resolve()}catch(e){return Promise.reject(e)}}return o.then((function(){var e,t=Ue();return(a=new We(""+(null===(e=h.connection.identity)||void 0===e?void 0:e.application),void 0,h.customLogger)).consoleLevel(h.logger.console),a.publishLevel(h.logger.publish),f("logger",a,t),Promise.resolve(void 0)})).then((function(){var e=Ue();i=new qe(h.connection,a.subLogger("connection"));var t=Promise.resolve(h.auth);return h.connection&&!h.auth&&(n?(a.trace("trying to get gw token..."),t=n.getGWToken().then((function(e){return a.trace("got GW token "+(null==e?void 0:e.substring(e.length-10))),{gatewayToken:e}}))):t=Promise.reject("You need to provide auth information")),t.then((function(e){var t;if("[object Object]"!==Object.prototype.toString.call(e))throw new Error("Invalid auth object - "+JSON.stringify(e));return t=e,i.login(t)})).then((function(){return f("connection",i,e),h})).catch((function(e){throw i&&i.logout(),e}))})).then((function(){return Promise.all([v(),(e=Ue(),t={connection:i,logger:a.subLogger("interop")},s=new yt(t),We.Interop=s,f(["interop","agm"],s,e),Promise.resolve()),g(),m()]);var e,t})).then((function(){return s.readyPromise})).then((function(){return y(h.libs||[])})).then((function(){var e=Object.keys(l).map((function(e){var t=l[e];return t.ready?t.ready():Promise.resolve()}));return Promise.all(e)})).then((function(){var r={coreVersion:"5.0.1",version:h.version};p.stop();var o={feedback:function(e){s&&s.invoke("T42.ACS.Feedback",e,"best")},info:r,logger:a,interop:s,agm:s,connection:i,metrics:c,contexts:u,bus:d,version:h.version,userConfig:e,done:function(){return null==a||a.info("done called by user..."),i.logout()}};return o.performance={get glueVer(){return h.version},get glueConfig(){return JSON.stringify(e)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var e=Object.keys(o).filter((function(e){var t;return"initTimes"!==e&&"agm"!==e&&(null===(t=o[e])||void 0===t?void 0:t.initTime)})).map((function(e){return{name:e,time:o[e].initTime,startTime:o[e].initStartTime,endTime:o[e].initEndTime}}));return e.push({name:"glue",startTime:p.startTime,endTime:p.endTime,time:p.period}),e}},Object.keys(l).forEach((function(e){var t=l[e];o[e]=t})),o.config={},Object.keys(h).forEach((function(e){o.config[e]=h[e]})),t&&t.extOptions&&Object.keys(t.extOptions).forEach((function(e){o.config[e]=null==t?void 0:t.extOptions[e]})),(null==t?void 0:t.enrichGlue)&&t.enrichGlue(o),n&&n.updatePerfData&&n.updatePerfData(o.performance),o})).catch((function(e){return Promise.reject({err:e,libs:l})}))};"undefined"!=typeof window&&(window.GlueCore=St),St.version="5.0.1",St.default=St;var xt,_t=(xt=St,function(e){return n(void 0,void 0,void 0,(function(){var t,o,i,s,a,c,u,d;return r(this,(function(p){switch(p.label){case 0:return[4,(f=e,n(void 0,void 0,void 0,(function(){var e,t,n,o;return r(this,(function(r){switch(r.label){case 0:return[4,A(f=null!=f?f:{})];case 1:return e=r.sent(),(t=Object.assign({},N,e,f)).extends&&(n=t.extends.lastIndexOf("/"),o=t.extends.substr(0,n+1)+"worker.js",t.worker=o),[2,t]}}))})))];case 1:return e=p.sent(),"undefined"!=typeof window&&(null==(t=window)?void 0:t.glue42gd)&&(null==t?void 0:t.Glue)?[2,t.Glue({windows:!0,logger:e.logger})]:(o=new I,s={libs:[{name:"windows",create:function(e){return i=new L(e.interop,o)}},{name:"notifications",create:function(e){return new E(e.interop)}},{name:"layouts",create:function(t){return new P(i,t.interop,t.logger.subLogger("layouts"),o,e)}}],version:"1.0.0"},a={gateway:{sharedWorker:null!==(u=null==e?void 0:e.worker)&&void 0!==u?u:"/glue/worker.js"},logger:null==e?void 0:e.logger},[4,xt(a,s)]);case 2:return c=p.sent(),o.start(c.interop,c.logger.subLogger("control")),[4,(h=c.windows.my(),l=c.interop,n(void 0,void 0,void 0,(function(){var e,t;return r(this,(function(n){switch(n.label){case 0:return e=O(h.id),l.methods().find((function(t){return t.name===e}))?[4,l.invoke(e)]:[3,2];case 1:t=n.sent(),h&&(h.setContext(t.returned.context),h.name=t.returned.name,h.parent=t.returned.parent),n.label=2;case 2:return[2]}}))})))];case 3:return p.sent(),(null===(d=e.layouts)||void 0===d?void 0:d.autoRestore)?[4,D(c)]:[3,5];case 4:p.sent(),p.label=5;case 5:return[4,q(c,e,o)];case 6:return p.sent(),[2,c]}var h,l,f}))}))});return"undefined"!=typeof window&&(window.GlueWeb=_t),_t.default=_t,_t.version="1.0.0",_t}));
